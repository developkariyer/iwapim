{% extends 'base.html.twig' %}
{% block title %} Sticker {% endblock %}
{% block navbaritems %}

{% endblock %}
{% block header %}

{% endblock %}
{% block content %}
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Çiçeksepeti Ürünleri</h1>

        <!-- Başarılı mesajlar -->
        {% for message in app.flashes('success') %}
            <div class="alert alert-success">
                {{ message }}
            </div>
        {% endfor %}

        <div class="row">
            <!-- Sol Kenar Çubuğu - Kategori Listesi -->
            <div class="col-md-3 col-12 mb-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Çiçeksepeti Kategorileri</h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Kategori güncelleme butonu -->
                        <div class="p-3 border-bottom">
                            <form method="post" action="{{ path('update_category') }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-sync-alt me-2"></i> Kategorileri Güncelle
                                </button>
                            </form>
                        </div>

                        <!-- Kategori listesi -->
                        <div class="list-group list-group-flush">
                            <a href="{{ path('ciceksepeti_main_page') }}"
                               class="list-group-item list-group-item-action {% if app.request.get('category') is null %}active{% endif %}">
                                Tüm Kategoriler
                            </a>
                            {% for category in categories %}
                                <a href="{{ path('ciceksepeti_main_page', {'category': category.id}) }}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if app.request.get('category') == category.id %}active{% endif %}"
                                   data-id="{{ category.id }}">
                                    <span>{{ category.name }}</span>
                                    {% if category.count is defined %}
                                        <span class="badge bg-primary rounded-pill">{{ category.count }}</span>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Ana İçerik - Ürünler ve Varyantlar -->
            <div class="col-md-9 col-12">
                {% if app.request.get('category') %}
                    <div class="alert alert-info mb-4">
                        <strong>Kategori:</strong>
                        {% for category in categories %}
                            {% if category.id == app.request.get('category') %}
                                {{ category.name }}
                            {% endif %}
                        {% endfor %}
                        <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-sm btn-outline-secondary float-end">
                            <i class="fas fa-times"></i> Filtreyi Temizle
                        </a>
                    </div>
                {% endif %}

                {% if grouped|length > 0 %}
                    <div class="row" id="productList">
                        {% for mainCode, listings in grouped %}
                            {% set firstProduct = listings|first %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card product-card h-100">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0 text-truncate">{{ firstProduct.productName|default('Ürün ' ~ mainCode) }}</h5>
                                        <small class="text-muted">Ana Kod: {{ mainCode }}</small>
                                    </div>
                                    <div class="card-body p-0">
                                        <!-- Ürün görseli -->
                                        <div class="p-2 text-center product-image-container">
                                            {% if firstProduct.images is defined and firstProduct.images|length > 0 %}
                                                <img src="{{ firstProduct.images[0] }}" class="img-fluid product-image" alt="{{ firstProduct.productName }}">
                                            {% else %}
                                                <div class="no-image p-5 bg-light text-center">
                                                    <i class="fas fa-image fa-3x text-muted"></i>
                                                    <p class="mt-2 mb-0">Görsel yok</p>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Varyant sayısı -->
                                        <div class="variant-count p-2 bg-light border-top border-bottom">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-cubes me-1"></i> {{ listings|length }} varyant
                                            </span>
                                        </div>

                                        <!-- Varyant listesi (kapalı başlıyor) -->
                                        <div class="variants-container border-bottom d-none" data-main-code="{{ mainCode }}">
                                            <div class="list-group list-group-flush">
                                                {% for variant in listings %}
                                                    <div class="list-group-item p-2">
                                                        <div class="row g-0">
                                                            <div class="col-3">
                                                                {% if variant.images is defined and variant.images|length > 0 %}
                                                                    <img src="{{ variant.images[0] }}" class="img-fluid variant-image" alt="{{ variant.productName }}">
                                                                {% else %}
                                                                    <div class="variant-no-image text-center">
                                                                        <i class="fas fa-image text-muted"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-9">
                                                                <div class="ps-2">
                                                                    <h6 class="mb-1 text-truncate">{{ variant.productName|default('İsimsiz Varyant') }}</h6>
                                                                    <small class="d-block text-muted">Ürün Kodu: {{ variant.productCode|default('-') }}</small>
                                                                    <small class="d-block text-muted">Stok: {{ variant.stockQuantity|default(0) }}</small>
                                                                    <div class="mt-1">
                                                                        <span class="badge bg-primary">{{ variant.salesPrice|default('-') }} TL</span>
                                                                        {% if variant.variantIsActive %}
                                                                            <span class="badge bg-success">Aktif</span>
                                                                        {% else %}
                                                                            <span class="badge bg-danger">Pasif</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    <button class="btn btn-sm btn-outline-primary mt-2 edit-variant-btn"
                                                                            data-variant="{{ variant|json_encode()|e('html_attr') }}"
                                                                            data-bs-toggle="modal" data-bs-target="#variantEditModal">
                                                                        <i class="fas fa-edit me-1"></i> Düzenle
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer text-center">
                                        <button class="btn btn-sm btn-outline-primary toggle-variants" data-main-code="{{ mainCode }}">
                                            <i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            {% if app.request.get('category') %}
                                <h4>Bu kategoride ürün bulunamadı</h4>
                                <p class="mb-3">Başka bir kategori seçmeyi deneyebilir veya tüm ürünleri görüntüleyebilirsiniz.</p>
                                <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-primary">
                                    Tüm Ürünleri Göster
                                </a>
                            {% else %}
                                <h4>Hiç ürün bulunamadı</h4>
                                <p>Lütfen daha sonra tekrar deneyin veya sistem yöneticinize başvurun.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Varyant Düzenleme Modal -->
    <div class="modal fade" id="variantEditModal" tabindex="-1" aria-labelledby="variantEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="variantEditModalLabel">
                        <i class="fas fa-edit me-2"></i> Varyant Düzenle
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="modalLoadingSpinner" class="text-center p-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Varyant bilgileri yükleniyor...</p>
                    </div>
                    <div id="modalContent" class="d-none">
                        <form method="post" action="{{ path('update_variant') }}" id="variantEditForm">
                            <input type="hidden" id="editMainProductCode" name="mainProductCode" value="">
                            <input type="hidden" id="editProductCode" name="productCode" value="">

                            <div class="container-fluid">
                                <div class="row g-0">
                                    <!-- Sol sütun - Resimler -->
                                    <div class="col-md-4 border-end">
                                        <div class="p-3 bg-light border-bottom">
                                            <h6 class="mb-1">Ürün Görselleri</h6>
                                            <small class="text-muted">Ana ürün kodu: <span id="displayMainCode"></span></small>
                                        </div>
                                        <div class="p-3">
                                            <!-- Ana görsel önizleme -->
                                            <div class="text-center mb-3">
                                                <img id="mainImagePreview" src="" class="img-fluid border"
                                                     style="max-height: 220px; object-fit: contain;" alt="Ana görsel">
                                            </div>

                                            <!-- Görsel galerisi -->
                                            <div class="gallery-container">
                                                <div class="d-flex flex-wrap" id="galleryContainer">
                                                    <!-- Resimler JS ile eklenecek -->
                                                </div>

                                                <!-- Yeni görsel ekleme -->
                                                <div class="mt-3">
                                                    <div class="input-group input-group-sm">
                                                        <input type="url" class="form-control" id="imageUrlInput"
                                                               placeholder="https://ornek.com/resim.jpg">
                                                        <button type="button" class="btn btn-outline-primary" id="addImageBtn">
                                                            <i class="fas fa-plus"></i> Ekle
                                                        </button>
                                                    </div>
                                                    <small class="text-muted">Sadece https:// ile başlayan URL'ler eklenebilir.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sağ sütun - Form alanları -->
                                    <div class="col-md-8">
                                        <div class="p-3">
                                            <div class="row g-3">
                                                <div class="col-md-8">
                                                    <label class="form-label">Ürün Adı</label>
                                                    <input type="text" name="productName" id="editProductName" class="form-control">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Ürün Kodu</label>
                                                    <input type="text" id="displayProductCode" class="form-control" readonly>
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label">Barkod</label>
                                                    <input type="text" name="barcode" id="editBarcode" class="form-control">
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label">Kategori ID</label>
                                                    <input type="text" name="categoryId" id="editCategoryId" class="form-control">
                                                </div>

                                                <div class="col-12">
                                                    <hr class="my-2">
                                                    <h6>Fiyat ve Stok Bilgileri</h6>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label">Satış Fiyatı</label>
                                                    <div class="input-group">
                                                        <input type="text" name="salesPrice" id="editSalesPrice" class="form-control">
                                                        <span class="input-group-text">TL</span>
                                                    </div>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label">Liste Fiyatı</label>
                                                    <div class="input-group">
                                                        <input type="text" name="listPrice" id="editListPrice" class="form-control">
                                                        <span class="input-group-text">TL</span>
                                                    </div>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label">Stok Miktarı</label>
                                                    <input type="number" name="stockQuantity" id="editStockQuantity" class="form-control">
                                                </div>

                                                <div class="col-12">
                                                    <hr class="my-2">
                                                    <h6>Durum ve Açıklama</h6>
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label">Aktif Durumu</label>
                                                    <select name="variantIsActive" id="editIsActive" class="form-select">
                                                        <option value="1">Aktif</option>
                                                        <option value="0">Pasif</option>
                                                    </select>
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label">Desen/Renk</label>
                                                    <input type="text" name="pattern" id="editPattern" class="form-control">
                                                </div>

                                                <div class="col-12">
                                                    <label class="form-label">Açıklama</label>
                                                    <textarea name="description" id="editDescription" class="form-control" rows="3"></textarea>
                                                </div>

                                                <div class="col-12" id="attributesContainer">
                                                    <!-- Özellikler dinamik olarak eklenecek -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i> Değişiklikleri Kaydet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .gallery-item .btn-danger {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .gallery-item:hover .btn-danger {
            opacity: 1;
        }

        .active-image {
            border: 2px solid #0d6efd !important;
        }

        .gallery-container {
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
        }

        .modal-body {
            padding: 0 !important;
        }
        .product-card {
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .product-image-container {
            height: 200px;
            overflow: hidden;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .variant-image {
            width: 100%;
            height: 60px;
            object-fit: contain;
        }

        .variant-no-image {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .variant-count {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .no-image {
            background-color: #f8f9fa;
            color: #6c757d;
            padding: 20px;
        }

        .variants-container {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
{% endblock %}
{% block body_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Varyant göster/gizle düğmeleri
            const toggleButtons = document.querySelectorAll('.toggle-variants');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mainCode = this.getAttribute('data-main-code');
                    const variantsContainer = document.querySelector(`.variants-container[data-main-code="${mainCode}"]`);
                    const icon = this.querySelector('.toggle-icon');

                    if (variantsContainer.classList.contains('d-none')) {
                        variantsContainer.classList.remove('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-up toggle-icon"></i> Varyantları Gizle';
                    } else {
                        variantsContainer.classList.add('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster';
                    }
                });
            });

            // Modal ve form işlemleri
            const variantEditModal = document.getElementById('variantEditModal');
            const modalContent = document.getElementById('modalContent');
            const modalSpinner = document.getElementById('modalLoadingSpinner');
            const galleryContainer = document.getElementById('galleryContainer');

            // Varyant düzenleme düğmesine tıklama
            document.querySelectorAll('.edit-variant-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Yükleniyor göstergesini göster, içeriği gizle
                    modalSpinner.classList.remove('d-none');
                    modalContent.classList.add('d-none');

                    // Varyant verilerini al
                    const variant = JSON.parse(this.getAttribute('data-variant'));

                    // Spinner'ı gizle ve içeriği göster
                    setTimeout(() => {
                        modalSpinner.classList.add('d-none');
                        modalContent.classList.remove('d-none');

                        // Form elemanlarına verileri doldur
                        document.getElementById('variantEditModalLabel').textContent = 'Varyant Düzenle: ' + variant.productName;
                        document.getElementById('editMainProductCode').value = variant.mainProductCode;
                        document.getElementById('editProductCode').value = variant.productCode;
                        document.getElementById('displayMainCode').textContent = variant.mainProductCode;
                        document.getElementById('editProductName').value = variant.productName;
                        document.getElementById('displayProductCode').value = variant.productCode;
                        document.getElementById('editBarcode').value = variant.barcode || '';
                        document.getElementById('editCategoryId').value = variant.categoryId || '';
                        document.getElementById('editSalesPrice').value = variant.salesPrice || '';
                        document.getElementById('editListPrice').value = variant.listPrice || '';
                        document.getElementById('editStockQuantity').value = variant.stockQuantity || 0;
                        document.getElementById('editIsActive').value = variant.variantIsActive ? '1' : '0';
                        document.getElementById('editPattern').value = variant.pattern || '';
                        document.getElementById('editDescription').value = variant.description || '';

                        // Resim galerisi
                        galleryContainer.innerHTML = '';
                        if (variant.images && variant.images.length > 0) {
                            // Ana resmi göster
                            document.getElementById('mainImagePreview').src = variant.images[0];

                            // Tüm resimleri galeri olarak ekle
                            variant.images.forEach((img, index) => {
                                const isActive = index === 0;
                                const galleryItem = document.createElement('div');
                                galleryItem.className = 'gallery-item me-2 mb-2 position-relative';
                                galleryItem.setAttribute('data-url', img);

                                galleryItem.innerHTML = `
                            <img src="${img}" class="img-thumbnail gallery-image ${isActive ? 'active-image' : ''}"
                                 style="width: 60px; height: 60px; object-fit: contain; cursor: pointer;"
                                 alt="Görsel ${index+1}">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0"
                                    style="width: 18px; height: 18px; font-size: 10px; line-height: 1;">
                                <i class="fas fa-times"></i>
                            </button>
                            <input type="hidden" name="images[]" value="${img}">
                        `;

                                galleryContainer.appendChild(galleryItem);

                                // Resme tıklama olayı ekle
                                galleryItem.querySelector('img').addEventListener('click', function() {
                                    document.querySelectorAll('.gallery-image').forEach(i => {
                                        i.classList.remove('active-image');
                                    });
                                    this.classList.add('active-image');
                                    document.getElementById('mainImagePreview').src = this.src;
                                });

                                // Silme düğmesine tıklama olayı ekle
                                galleryItem.querySelector('.btn-danger').addEventListener('click', function() {
                                    if (confirm('Bu görseli silmek istediğinize emin misiniz?')) {
                                        const img = galleryItem.querySelector('img');
                                        const isActive = img.classList.contains('active-image');

                                        galleryItem.remove();

                                        // Eğer aktif resim silindiyse ve başka resim varsa, ilk resmi aktif yap
                                        if (isActive && galleryContainer.querySelectorAll('.gallery-item').length > 0) {
                                            const firstImg = galleryContainer.querySelector('.gallery-image');
                                            firstImg.classList.add('active-image');
                                            document.getElementById('mainImagePreview').src = firstImg.src;
                                        } else if (galleryContainer.querySelectorAll('.gallery-item').length === 0) {
                                            document.getElementById('mainImagePreview').src = '';
                                        }
                                    }
                                });
                            });
                        } else {
                            document.getElementById('mainImagePreview').src = '';
                        }

                        // Özellikler tablosu
                        const attributesContainer = document.getElementById('attributesContainer');
                        attributesContainer.innerHTML = '';

                        if (variant.attributes && variant.attributes.length > 0) {
                            let attributesHTML = `
                        <hr class="my-2">
                        <h6>Ürün Özellikleri</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                <tr>
                                    <th>Özellik</th>
                                    <th>Değer</th>
                                </tr>
                                </thead>
                                <tbody>
                    `;

                            variant.attributes.forEach(attr => {
                                attributesHTML += `
                            <tr>
                                <td class="fw-bold">${attr.parentName || ''}</td>
                                <td>${attr.name || ''}</td>
                            </tr>
                        `;
                            });

                            attributesHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;

                            attributesContainer.innerHTML = attributesHTML;
                        }
                    }, 500);
                });
            });

            // Yeni resim ekleme işlemi
            document.getElementById('addImageBtn').addEventListener('click', function() {
                const url = document.getElementById('imageUrlInput').value.trim();

                if (!url) {
                    alert('Lütfen bir URL girin');
                    return;
                }

                if (!url.startsWith('https://')) {
                    alert('Sadece https:// ile başlayan URL\'ler eklenebilir');
                    return;
                }

                // Resmin yüklenebildiğinden emin olmak için test et
                const testImage = new Image();
                testImage.onload = function() {
                    const isFirstImage = galleryContainer.querySelectorAll('.gallery-item').length === 0;

                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item me-2 mb-2 position-relative';
                    galleryItem.setAttribute('data-url', url);

                    galleryItem.innerHTML = `
                <img src="${url}" class="img-thumbnail gallery-image ${isFirstImage ? 'active-image' : ''}"
                     style="width: 60px; height: 60px; object-fit: contain; cursor: pointer;"
                     alt="Yeni Görsel">
                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0"
                        style="width: 18px; height: 18px; font-size: 10px; line-height: 1;">
                    <i class="fas fa-times"></i>
                </button>
                <input type="hidden" name="images[]" value="${url}">
            `;

                    galleryContainer.appendChild(galleryItem);

                    // Resme tıklama olayı ekle
                    galleryItem.querySelector('img').addEventListener('click', function() {
                        document.querySelectorAll('.gallery-image').forEach(i => {
                            i.classList.remove('active-image');
                        });
                        this.classList.add('active-image');
                        document.getElementById('mainImagePreview').src = this.src;
                    });

                    // Silme düğmesine tıklama olayı ekle
                    galleryItem.querySelector('.btn-danger').addEventListener('click', function() {
                        if (confirm('Bu görseli silmek istediğinize emin misiniz?')) {
                            const img = galleryItem.querySelector('img');
                            const isActive = img.classList.contains('active-image');

                            galleryItem.remove();

                            if (isActive && galleryContainer.querySelectorAll('.gallery-item').length > 0) {
                                const firstImg = galleryContainer.querySelector('.gallery-image');
                                firstImg.classList.add('active-image');
                                document.getElementById('mainImagePreview').src = firstImg.src;
                            } else if (galleryContainer.querySelectorAll('.gallery-item').length === 0) {
                                document.getElementById('mainImagePreview').src = '';
                            }
                        }
                    });

                    // İlk resimse ana resmi güncelle
                    if (isFirstImage) {
                        document.getElementById('mainImagePreview').src = url;
                    }

                    // Input'u temizle
                    document.getElementById('imageUrlInput').value = '';
                };

                testImage.onerror = function() {
                    alert('Görsel yüklenemedi. Lütfen geçerli bir görsel URL\'si girin.');
                };

                testImage.src = url;
            });

            // Form gönderimi
            document.getElementById('variantEditForm').addEventListener('submit', function(e) {
                e.preventDefault();

                // Form verilerini topla
                const formData = new FormData(this);

                // Resim listesi
                const images = [];
                document.querySelectorAll('#galleryContainer .gallery-item').forEach(item => {
                    images.push(item.getAttribute('data-url'));
                });
                formData.append('imageList', JSON.stringify(images));

                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Varyant başarıyla güncellendi');
                            window.location.reload(); // Sayfayı yenile
                        } else {
                            alert('Hata: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Hata:', error);
                        alert('İşlem sırasında bir hata oluştu.');
                    });
            });
        });
    </script>

{% endblock %}
