{% extends 'base.html.twig' %}
{% block title %} Sticker {% endblock %}
{% block navbaritems %}

{% endblock %}
{% block header %}

{% endblock %}
{% block content %}
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Çiçeksepeti Ürünleri</h1>

        <!-- Başarılı mesajlar -->
        {% for message in app.flashes('success') %}
            <div class="alert alert-success">
                {{ message }}
            </div>
        {% endfor %}

        <div class="row">
            <!-- Sol Kenar Çubuğu - Kategori Listesi -->
            <div class="col-md-3 col-12 mb-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Çiçeksepeti Kategorileri</h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Kategori güncelleme butonu -->
                        <div class="p-3 border-bottom">
                            <form method="post" action="{{ path('update_category') }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-sync-alt me-2"></i> Kategorileri Güncelle
                                </button>
                            </form>
                        </div>

                        <!-- Kategori listesi -->
                        <div class="list-group list-group-flush">
                            <a href="{{ path('ciceksepeti_main_page') }}"
                               class="list-group-item list-group-item-action {% if app.request.get('category') is null %}active{% endif %}">
                                Tüm Kategoriler
                            </a>
                            {% for category in categories %}
                                <a href="{{ path('ciceksepeti_main_page', {'category': category.id}) }}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if app.request.get('category') == category.id %}active{% endif %}"
                                   data-id="{{ category.id }}">
                                    <span>{{ category.name }}</span>
                                    {% if category.count is defined %}
                                        <span class="badge bg-primary rounded-pill">{{ category.count }}</span>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Ana İçerik - Ürünler ve Varyantlar -->
            <div class="col-md-9 col-12">
                {% if app.request.get('category') %}
                    <div class="alert alert-info mb-4">
                        <strong>Kategori:</strong>
                        {% for category in categories %}
                            {% if category.id == app.request.get('category') %}
                                {{ category.name }}
                            {% endif %}
                        {% endfor %}
                        <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-sm btn-outline-secondary float-end">
                            <i class="fas fa-times"></i> Filtreyi Temizle
                        </a>
                    </div>
                {% endif %}

                {% if grouped|length > 0 %}
                    <div class="row" id="productList">
                        {% for mainCode, listings in grouped %}
                            {% set firstProduct = listings|first %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card product-card h-100">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0 text-truncate">{{ firstProduct.productName|default('Ürün ' ~ mainCode) }}</h5>
                                        <small class="text-muted">Ana Kod: {{ mainCode }}</small>
                                    </div>
                                    <div class="card-body p-0">
                                        <!-- Ürün görseli -->
                                        <div class="p-2 text-center product-image-container">
                                            {% if firstProduct.images is defined and firstProduct.images|length > 0 %}
                                                <img src="{{ firstProduct.images[0] }}" class="img-fluid product-image" alt="{{ firstProduct.productName }}">
                                            {% else %}
                                                <div class="no-image p-5 bg-light text-center">
                                                    <i class="fas fa-image fa-3x text-muted"></i>
                                                    <p class="mt-2 mb-0">Görsel yok</p>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Varyant sayısı -->
                                        <div class="variant-count p-2 bg-light border-top border-bottom">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-cubes me-1"></i> {{ listings|length }} varyant
                                            </span>
                                        </div>

                                        <!-- Varyant listesi (kapalı başlıyor) -->
                                        <div class="variants-container border-bottom d-none" data-main-code="{{ mainCode }}">
                                            <div class="list-group list-group-flush">
                                                {% for variant in listings %}
                                                    <div class="list-group-item p-2 variant-item" data-index="{{ loop.index0 }}">
                                                        <!-- Varyant içeriği (değişmeden kalır) -->
                                                    </div>
                                                    <div class="list-group-item p-2">
                                                        <div class="row g-0">
                                                            <div class="col-3">
                                                                {% if variant.images is defined and variant.images|length > 0 %}
                                                                    <img src="{{ variant.images[0] }}" class="img-fluid variant-image" alt="{{ variant.productName }}">
                                                                {% else %}
                                                                    <div class="variant-no-image text-center">
                                                                        <i class="fas fa-image text-muted"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-9">
                                                                <div class="ps-2">
                                                                    <h6 class="mb-1 text-truncate">{{ variant.productName|default('İsimsiz Varyant') }}</h6>
                                                                    <small class="d-block text-muted">Ürün Kodu: {{ variant.productCode|default('-') }}</small>
                                                                    <small class="d-block text-muted">Stok: {{ variant.stockQuantity|default(0) }}</small>
                                                                    <div class="mt-1">
                                                                        <span class="badge bg-primary">{{ variant.salesPrice|default('-') }} TL</span>
                                                                        {% if variant.variantIsActive %}
                                                                            <span class="badge bg-success">Aktif</span>
                                                                        {% else %}
                                                                            <span class="badge bg-danger">Pasif</span>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer text-center">
                                        <button class="btn btn-sm btn-outline-primary toggle-variants" data-main-code="{{ mainCode }}">
                                            <i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            {% if app.request.get('category') %}
                                <h4>Bu kategoride ürün bulunamadı</h4>
                                <p class="mb-3">Başka bir kategori seçmeyi deneyebilir veya tüm ürünleri görüntüleyebilirsiniz.</p>
                                <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-primary">
                                    Tüm Ürünleri Göster
                                </a>
                            {% else %}
                                <h4>Hiç ürün bulunamadı</h4>
                                <p>Lütfen daha sonra tekrar deneyin veya sistem yöneticinize başvurun.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="modal fade" id="variantDetailModal" tabindex="-1" aria-labelledby="variantDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="variantDetailModalLabel">Varyant Detayları</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="container-fluid">
                            <div class="row">
                                <!-- Varyant listesi (sol panel) -->
                                <div class="col-md-3 border-end" style="max-height: calc(80vh - 120px); overflow-y: auto;">
                                    <div id="variant-list" class="list-group list-group-flush">
                                        <!-- Varyantlar dinamik olarak buraya yüklenecek -->
                                        <div class="text-center p-3">
                                            <div class="spinner-border spinner-border-sm text-primary"></div>
                                            <span class="ms-2">Yükleniyor...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Varyant form (sağ panel) -->
                                <div class="col-md-9">
                                    <div id="variant-form-container" style="max-height: calc(80vh - 120px); overflow-y: auto;">
                                        <!-- Form içeriği dinamik olarak buraya yüklenecek -->
                                        <div class="text-center p-5">
                                            <i class="fas fa-arrow-left fa-2x mb-3 text-muted"></i>
                                            <p>Düzenlemek için listeden bir varyant seçin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .product-card {
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .product-image-container {
            height: 200px;
            overflow: hidden;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .variant-image {
            width: 100%;
            height: 60px;
            object-fit: contain;
        }

        .variant-no-image {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .variant-count {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .no-image {
            background-color: #f8f9fa;
            color: #6c757d;
            padding: 20px;
        }

        .variants-container {
            max-height: 300px;
            overflow-y: auto;
        }
        .gallery-item {
            position: relative;
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .gallery-image.active {
            border: 2px solid #0d6efd !important;
        }

        .delete-image {
            position: absolute;
            top: -5px;
            right: -5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .gallery-item:hover .delete-image {
            opacity: 1;
        }

        .form-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .form-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .variant-item-image {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .image-preview {
            max-height: 200px;
            object-fit: contain;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
    </style>
{% endblock %}
{% block body_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButtons = document.querySelectorAll('.toggle-variants');

            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mainCode = this.getAttribute('data-main-code');
                    const variantsContainer = document.querySelector(`.variants-container[data-main-code="${mainCode}"]`);
                    const icon = this.querySelector('.toggle-icon');

                    if (variantsContainer.classList.contains('d-none')) {
                        variantsContainer.classList.remove('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-up toggle-icon"></i> Varyantları Gizle';
                    } else {
                        variantsContainer.classList.add('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster';
                    }
                });
            });
        });
        document.addEventListener('DOMContentLoaded', function() {
            // Mevcut toggle-variants kodunu koru
            const toggleButtons = document.querySelectorAll('.toggle-variants');

            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mainCode = this.getAttribute('data-main-code');
                    const variantsContainer = document.querySelector(`.variants-container[data-main-code="${mainCode}"]`);
                    const icon = this.querySelector('.toggle-icon');

                    if (variantsContainer.classList.contains('d-none')) {
                        variantsContainer.classList.remove('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-up toggle-icon"></i> Varyantları Gizle';
                    } else {
                        variantsContainer.classList.add('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster';
                    }
                });
            });

            // Varyant detayları için kodlar
            // Modal ve ilgili DOM elementleri
            const variantDetailModal = new bootstrap.Modal(document.getElementById('variantDetailModal'));
            const variantList = document.getElementById('variant-list');
            const variantFormContainer = document.getElementById('variant-form-container');
            const modalTitle = document.getElementById('variantDetailModalLabel');

            // Her bir varyanta tıklama olayı ekle
            document.querySelectorAll('.variant-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const mainCode = this.closest('.variants-container').dataset.mainCode;
                    const variantIndex = this.dataset.index;
                    const productName = this.querySelector('.variant-name').textContent;

                    // Modal başlığını ayarla
                    modalTitle.textContent = `Varyant Detayları: ${productName}`;

                    // Modal'ı göster
                    variantDetailModal.show();

                    // Varyantları yükle
                    loadVariantsList(mainCode, variantIndex);
                });
            });

            // Varyant listesini yükle
            function loadVariantsList(mainCode, activeIndex = null) {
                let listHTML = '';

                {% if grouped is defined %}
                {% for code, listings in grouped %}
                if ('{{ code }}' === mainCode) {
                    {% for variant in listings %}
                    listHTML += `
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center py-2 px-3 ${{{ loop.index0 }} == activeIndex ? 'active' : ''}"
                       data-index="{{ loop.index0 }}" data-main-code="{{ code }}">
                        <div class="me-2">
                            {% if variant.images is defined and variant.images|length > 0 %}
                                <img src="{{ variant.images[0] }}" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: contain;" alt="">
                            {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold text-truncate">{{ variant.productName|default('İsimsiz Varyant')|e('js') }}</div>
                            <small class="text-muted">{{ variant.productCode|default('-') }}</small>
                        </div>
                    </a>
                `;
                    {% endfor %}
                }
                {% endfor %}
                {% endif %}

                variantList.innerHTML = listHTML || '<div class="p-3 text-center text-muted">Varyant bulunamadı</div>';

                // Varyant listesi öğelerine tıklama olayı ekle
                variantList.querySelectorAll('.list-group-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();

                        // Aktif sınıfını değiştir
                        variantList.querySelectorAll('.list-group-item').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');

                        // Varyant formunu yükle
                        const variantIndex = this.dataset.index;
                        const mainCode = this.dataset.mainCode;

                        loadVariantForm(mainCode, variantIndex);
                    });
                });

                // Aktif varyant varsa onu seç ve formunu yükle
                if (activeIndex !== null) {
                    const activeItem = variantList.querySelector(`.list-group-item[data-index="${activeIndex}"]`);
                    if (activeItem) {
                        activeItem.classList.add('active');
                        loadVariantForm(mainCode, activeIndex);
                    }
                }
            }

            // Varyant formunu yükle
            function loadVariantForm(mainCode, variantIndex) {
                variantFormContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-3">Varyant bilgileri yükleniyor...</p></div>';

                setTimeout(() => {
                    let formHTML = '';

                    {% if grouped is defined %}
                    {% for code, listings in grouped %}
                    if ('{{ code }}' === mainCode) {
                        {% for variant in listings %}
                        if ({{ loop.index0 }} == variantIndex) {
                            formHTML = `
                            <form id="variant-edit-form" class="p-4">
                                <input type="hidden" name="variantIndex" value="${variantIndex}">
                                <input type="hidden" name="mainProductCode" value="{{ variant.mainProductCode|default('')|e('js') }}">
                                <input type="hidden" name="productCode" value="{{ variant.productCode|default('')|e('js') }}">

                                <div class="row mb-4">
                                    <!-- Resim Galerisi -->
                                    <div class="col-lg-4">
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Ürün Görselleri</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3 text-center">
                                                    <img id="main-image-preview" src="{{ variant.images[0]|default('')|e('js') }}"
                                                         class="img-fluid border" style="max-height: 200px; object-fit: contain;" alt="Ana Görsel">
                                                </div>

                                                <div class="d-flex flex-wrap gap-2 mb-3" id="gallery-container">
                                                    {% if variant.images is defined %}
                                                    {% for img in variant.images %}
                                                    <div class="gallery-item" draggable="true" data-url="{{ img }}">
                                                        <img src="{{ img }}" class="img-thumbnail gallery-image {% if loop.first %}active{% endif %}"
                                                             style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;" alt="">
                                                        <button type="button" class="btn btn-sm btn-danger delete-image position-absolute top-0 end-0"
                                                                style="padding: 0.1rem 0.3rem; font-size: 0.65rem;">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                </div>

                                                <div class="input-group mb-2">
                                                    <input type="url" class="form-control form-control-sm" id="image-url-input"
                                                           placeholder="https:// ile başlayan görsel URL'si">
                                                    <button class="btn btn-sm btn-primary" type="button" id="add-image-url">
                                                        <i class="fas fa-plus"></i> Ekle
                                                    </button>
                                                </div>
                                                <div class="small text-muted">Sadece https:// ile başlayan adresler eklenebilir</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ürün Bilgileri -->
                                    <div class="col-lg-8">
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Ürün Bilgileri</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-8 mb-3">
                                                        <label for="productName" class="form-label">Ürün Adı</label>
                                                        <input type="text" class="form-control" id="productName" name="productName"
                                                               value="{{ variant.productName|default('')|e('js') }}">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="productCode" class="form-label">Ürün Kodu</label>
                                                        <input type="text" class="form-control" readonly
                                                               value="{{ variant.productCode|default('')|e('js') }}">
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label for="salesPrice" class="form-label">Satış Fiyatı</label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="salesPrice" name="salesPrice"
                                                                   value="{{ variant.salesPrice|default('')|e('js') }}">
                                                            <span class="input-group-text">TL</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="stockQuantity" class="form-label">Stok</label>
                                                        <input type="number" class="form-control" id="stockQuantity" name="stockQuantity"
                                                               value="{{ variant.stockQuantity|default('0')|e('js') }}">
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label d-block">Durum</label>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input" type="radio" name="variantIsActive" id="active-yes" value="1"
                                                                  {% if variant.variantIsActive %}checked{% endif %}>
                                                            <label class="form-check-label" for="active-yes">Aktif</label>
                                                        </div>
                                                        <div class="form-check form-check-inline">
                                                            <input class="form-check-input" type="radio" name="variantIsActive" id="active-no" value="0"
                                                                  {% if not variant.variantIsActive %}checked{% endif %}>
                                                            <label class="form-check-label" for="active-no">Pasif</label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="description" class="form-label">Açıklama</label>
                                                    <textarea class="form-control" id="description" name="description" rows="3">{{ variant.description|default('')|e('js') }}</textarea>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end mt-3">
                                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">İptal</button>
                                            <button type="submit" class="btn btn-primary">Kaydet</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        `;
                        }
                        {% endfor %}
                    }
                    {% endfor %}
                    {% endif %}

                    if (formHTML) {
                        variantFormContainer.innerHTML = formHTML;
                        initFormEvents();
                    } else {
                        variantFormContainer.innerHTML = '<div class="alert alert-danger m-3">Varyant bulunamadı</div>';
                    }
                }, 300);
            }

            // Form olaylarını başlat
            function initFormEvents() {
                // Galeri resimleri tıklama olayı
                document.querySelectorAll('.gallery-image').forEach(img => {
                    img.addEventListener('click', function() {
                        document.querySelectorAll('.gallery-image').forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById('main-image-preview').src = this.src;
                    });
                });

                // Resim silme düğmeleri
                document.querySelectorAll('.delete-image').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm('Bu görseli silmek istediğinize emin misiniz?')) {
                            const galleryItem = this.closest('.gallery-item');
                            const isActive = galleryItem.querySelector('.gallery-image').classList.contains('active');

                            // Eğer silinen resim aktifse, başka bir resmi aktif yap
                            if (isActive) {
                                const nextItem = galleryItem.nextElementSibling || galleryItem.previousElementSibling;
                                if (nextItem) {
                                    const nextImg = nextItem.querySelector('.gallery-image');
                                    nextImg.classList.add('active');
                                    document.getElementById('main-image-preview').src = nextImg.src;
                                } else {
                                    document.getElementById('main-image-preview').src = '';
                                }
                            }

                            galleryItem.remove();
                        }
                    });
                });

                // Resim URL'si ile ekleme
                const addImageBtn = document.getElementById('add-image-url');
                const imageUrlInput = document.getElementById('image-url-input');

                if (addImageBtn && imageUrlInput) {
                    addImageBtn.addEventListener('click', function() {
                        const url = imageUrlInput.value.trim();
                        if (url && url.startsWith('https://')) {
                            // Resmin yüklenebilir olduğundan emin olmak için test et
                            const testImg = new Image();
                            testImg.onload = function() {
                                // Resim yüklenebildi, galeriye ekle
                                const galleryContainer = document.getElementById('gallery-container');
                                const isFirstImage = galleryContainer.querySelectorAll('.gallery-item').length === 0;

                                const galleryItem = document.createElement('div');
                                galleryItem.className = 'gallery-item';
                                galleryItem.setAttribute('draggable', 'true');
                                galleryItem.setAttribute('data-url', url);
                                galleryItem.innerHTML = `
                                <img src="${url}" class="img-thumbnail gallery-image ${isFirstImage ? 'active' : ''}"
                                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;" alt="">
                                <button type="button" class="btn btn-sm btn-danger delete-image position-absolute top-0 end-0"
                                        style="padding: 0.1rem 0.3rem; font-size: 0.65rem;">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;

                                galleryContainer.appendChild(galleryItem);

                                // Yeni eklenen resme tıklama olayını ekle
                                const newImg = galleryItem.querySelector('.gallery-image');
                                newImg.addEventListener('click', function() {
                                    document.querySelectorAll('.gallery-image').forEach(i => i.classList.remove('active'));
                                    this.classList.add('active');
                                    document.getElementById('main-image-preview').src = this.src;
                                });

                                // Yeni eklenen resmin silme düğmesine olay ekle
                                const deleteBtn = galleryItem.querySelector('.delete-image');
                                deleteBtn.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    if (confirm('Bu görseli silmek istediğinize emin misiniz?')) {
                                        const isActive = galleryItem.querySelector('.gallery-image').classList.contains('active');

                                        if (isActive) {
                                            const nextItem = galleryItem.nextElementSibling || galleryItem.previousElementSibling;
                                            if (nextItem) {
                                                const nextImg = nextItem.querySelector('.gallery-image');
                                                nextImg.classList.add('active');
                                                document.getElementById('main-image-preview').src = nextImg.src;
                                            } else {
                                                document.getElementById('main-image-preview').src = '';
                                            }
                                        }

                                        galleryItem.remove();
                                    }
                                });

                                // Eğer ilk resimse ana görüntüye de yerleştir
                                if (isFirstImage) {
                                    document.getElementById('main-image-preview').src = url;
                                }

                                // Input'u temizle
                                imageUrlInput.value = '';
                            };

                            testImg.onerror = function() {
                                alert('Geçersiz görsel URL\'si. Resim yüklenemedi.');
                            };

                            testImg.src = url;
                        } else {
                            alert('Lütfen https:// ile başlayan geçerli bir görsel URL\'si girin.');
                        }
                    });
                }

                // Form gönderimi olayı
                const form = document.getElementById('variant-edit-form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();

                        // Form verilerini topla
                        const formData = new FormData(form);

                        // Resim bilgilerini ekle
                        const images = [];
                        document.querySelectorAll('.gallery-item').forEach(item => {
                            images.push(item.getAttribute('data-url'));
                        });
                        formData.append('images', JSON.stringify(images));

                        // AJAX ile gönder
                        fetch('{{ path('update_variant') }}', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Varyant başarıyla güncellendi');
                                    // İsteğe bağlı: Sayfayı yenile veya modali kapat
                                    // window.location.reload();
                                } else {
                                    alert('Hata: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('İşlem sırasında bir hata oluştu.');
                            });
                    });
                }
            }

            // Varyant öğelerine tıklama olayı ekle
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    const mainCode = this.closest('.variants-container').dataset.mainCode;
                    const variantIndex = Array.from(this.parentNode.children).indexOf(this);

                    // Modalı hazırla ve aç
                    modalTitle.textContent = 'Varyant Detayı: ' + this.querySelector('h6').textContent;
                    variantDetailModal.show();

                    // Varyantları yükle
                    loadVariantsList(mainCode, variantIndex);
                });
            });
        });
    </script>

{% endblock %}
