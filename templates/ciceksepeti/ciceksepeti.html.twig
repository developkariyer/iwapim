{% extends 'base.html.twig' %}
{% block title %} Sticker {% endblock %}
{% block navbaritems %}

{% endblock %}
{% block header %}

{% endblock %}
{% block content %}
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Çiçeksepeti Ürünleri</h1>

        <!-- Başarılı mesajlar -->
        {% for message in app.flashes('success') %}
            <div class="alert alert-success">
                {{ message }}
            </div>
        {% endfor %}

        <div class="row">
            <!-- Sol Kenar Çubuğu - Kategori Listesi -->
            <div class="col-md-3 col-12 mb-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Çiçeksepeti Kategorileri</h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Kategori güncelleme butonu -->
                        <div class="p-3 border-bottom">
                            <form method="post" action="{{ path('update_category') }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-sync-alt me-2"></i> Kategorileri Güncelle
                                </button>
                            </form>
                        </div>

                        <!-- Kategori listesi -->
                        <div class="list-group list-group-flush">
                            <a href="{{ path('ciceksepeti_main_page') }}"
                               class="list-group-item list-group-item-action {% if app.request.get('category') is null %}active{% endif %}">
                                Tüm Kategoriler
                            </a>
                            {% for category in categories %}
                                <a href="{{ path('ciceksepeti_main_page', {'category': category.id}) }}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if app.request.get('category') == category.id %}active{% endif %}"
                                   data-id="{{ category.id }}">
                                    <span>{{ category.name }}</span>
                                    {% if category.count is defined %}
                                        <span class="badge bg-primary rounded-pill">{{ category.count }}</span>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Ana İçerik - Ürünler ve Varyantlar -->
            <div class="col-md-9 col-12">
                <div class="row mb-3">
                    <div class="col-6">
                        <button type="button" class="btn btn-primary w-100" id="newListingBtn" data-bs-toggle="modal" data-bs-target="#newListingModal">
                            <i class="fas fa-plus-circle me-2"></i>Yeni Listing
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-primary w-100" id="checkListingBtn" data-bs-toggle="modal" data-bs-target="#checkListingModal">
                            <i class="fas fa-search me-2"></i>Listing Kontrol
                        </button>
                    </div>
                </div>
                {% if app.request.get('category') %}
                    <div class="alert alert-info mb-4">
                        <strong>Kategori:</strong>
                        {% for category in categories %}
                            {% if category.id == app.request.get('category') %}
                                {{ category.name }}
                            {% endif %}
                        {% endfor %}
                        <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-sm btn-outline-secondary float-end">
                            <i class="fas fa-times"></i> Filtreyi Temizle
                        </a>
                    </div>
                {% endif %}

                {% if grouped|length > 0 %}
                    <div class="row" id="productList">
                        {% for mainCode, listings in grouped %}
                            {% set firstProduct = listings|first %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card product-card h-100">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0 text-truncate">{{ firstProduct.productName|default('Ürün ' ~ mainCode) }}</h5>
                                        <small class="text-muted">Ana Kod: {{ mainCode }}</small>
                                    </div>
                                    <div class="card-body p-0">
                                        <!-- Ürün görseli -->
                                        <div class="p-2 text-center product-image-container">
                                            {% if firstProduct.images is defined and firstProduct.images|length > 0 %}
                                                <img src="{{ firstProduct.images[0] }}" class="img-fluid product-image" alt="{{ firstProduct.productName }}">
                                            {% else %}
                                                <div class="no-image p-5 bg-light text-center">
                                                    <i class="fas fa-image fa-3x text-muted"></i>
                                                    <p class="mt-2 mb-0">Görsel yok</p>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Varyant sayısı -->
                                        <div class="variant-count p-2 bg-light border-top border-bottom">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-cubes me-1"></i> {{ listings|length }} varyant
                                            </span>
                                        </div>

                                        <!-- Varyant listesi (kapalı başlıyor) -->
                                        <div class="variants-container border-bottom d-none" data-main-code="{{ mainCode }}">
                                            <div class="list-group list-group-flush">
                                                {% for variant in listings %}
                                                    <div class="list-group-item p-2">
                                                        <div class="row g-0">
                                                            <div class="col-3">
                                                                {% if variant.images is defined and variant.images|length > 0 %}
                                                                    <a href="{{ variant.link }}" target="_blank"><img src="{{ variant.images[0] }}" class="img-fluid variant-image" alt="{{ variant.productName }}"></a>
                                                                {% else %}
                                                                    <div class="variant-no-image text-center">
                                                                        <i class="fas fa-image text-muted"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-9">
                                                                <div class="ps-2">
                                                                    <h6 class="mb-1 text-truncate">{{ variant.productName|default('İsimsiz Varyant') }}</h6>
                                                                    <small class="d-block text-muted">Ürün Kodu: {{ variant.productCode|default('-') }}</small>
                                                                    <small class="d-block text-muted">Stok: {{ variant.stockQuantity|default(0) }}</small>
                                                                    <small class="d-block text-muted">Favori: {{ variant.numberOfFavorites|default(0) }}</small>
                                                                    <div class="mt-1">
                                                                        <span class="badge bg-primary">{{ variant.salesPrice|default('-') }} TL</span>
                                                                        {% if variant.variantIsActive %}
                                                                            <span class="badge bg-success">Aktif</span>
                                                                        {% else %}
                                                                            <span class="badge bg-danger">Pasif</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    <button
                                                                            class="btn btn-sm btn-outline-primary mt-2 open-edit-modal"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#editModal"
                                                                            data-product-link="{{ variant.link }}"
                                                                            data-product-name="{{ variant.productName }}"
                                                                            data-product-code="{{ variant.productCode }}"
                                                                            data-product-stock-code="{{ variant.stockCode }}"
                                                                            data-barcode="{{ variant.barcode }}"
                                                                            data-stock="{{ variant.stockQuantity }}"
                                                                            data-attributes="{{ variant.attributes|json_encode|e('html_attr') }}"
                                                                            data-delivery-type="{{ variant.deliveryType }}"
                                                                            data-delivery-message-type="{{ variant.deliveryMessageType }}"
                                                                            data-commission-rate="{{ variant.commissionRate }}"
                                                                            data-main-product-code="{{ variant.mainProductCode }}"
                                                                            data-sales-price="{{ variant.salesPrice }}"
                                                                            data-list-price="{{ variant.listPrice }}"
                                                                            data-description="{{ variant.description }}"
                                                                            data-category-id="{{ variant.categoryId }}"
                                                                            data-variant-isactive="{{ variant.variantIsActive ? '1' : '0' }}"
                                                                            data-product-isactive="{{ variant.productIsActive }}"
                                                                            data-images="{{ variant.images|json_encode|e('html_attr') }}"
                                                                    >
                                                                        Düzenle
                                                                    </button>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer text-center">
                                        <button class="btn btn-sm btn-outline-primary toggle-variants" data-main-code="{{ mainCode }}">
                                            <i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            {% if app.request.get('category') %}
                                <h4>Bu kategoride ürün bulunamadı</h4>
                                <p class="mb-3">Başka bir kategori seçmeyi deneyebilir veya tüm ürünleri görüntüleyebilirsiniz.</p>
                                <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-primary">
                                    Tüm Ürünleri Göster
                                </a>
                            {% else %}
                                <h4>Hiç ürün bulunamadı</h4>
                                <p>Lütfen daha sonra tekrar deneyin veya sistem yöneticinize başvurun.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <form id="variantForm" method="post" action="/variant/update">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Varyant Düzenle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label>Ürün Adı (Title)</label>
                                <input type="text" name="productName" id="formProductName" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Ana Ürün Kodu (PIM Identifier)</label>
                                <input type="text" name="mainProductCode" id="formMainProductCode" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Stok Kodu (IWASKU)</label>
                                <input type="text" name="stockCode" id="formStockCode" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Barkod (EAN)</label>
                                <input type="text" name="barcode" id="formBarcode" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Ürün Kodu (Ciceksepeti Product Code)</label>
                                <input type="text" name="productCode" id="formProductCode" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Satış Fiyatı (TL)</label>
                                <input type="text" name="salesPrice" id="formSalesPrice" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Liste Fiyatı (Üstü Çizili Fiyat TL)</label>
                                <input type="text" name="listPrice" id="formListPrice" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Stok Miktarı</label>
                                <input type="number" name="stockQuantity" id="formStock" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Komisyon Oranı</label>
                                <input type="text" name="commissionRate" id="formCommissionRate" class="form-control" readonly>
                            </div>

                            <div class="col-md-6">
                                <label>Teslimat Tipi</label>
                                <input type="text" name="deliveryType" id="formDeliveryType" class="form-control" readonly>
                            </div>

                            <div class="col-md-6">
                                <label>Teslimat Aralığı</label>
                                <input type="text" name="deliveryMessageType" id="formDeliveryMessageType" class="form-control" readonly>
                            </div>
                            <div class="col-12">
                                <label>Açıklama</label>
                                <textarea name="description" id="formDescription" class="form-control" rows="3" ></textarea>
                            </div>
                            <div class="col-md-6">
                                <label>Listing Aktif mi?</label>
                                <input type="text" name="productIsActive" id="formProductActive" class="form-control" readonly>
                            </div>

                            <div class="col-md-6">
                                <label>Variant Aktif mi?</label>
                                <input type="number" name="variantIsActive" id="formVariantActive" class="form-control" min="0" max="1" value="1">
                            </div>
                            <div class="col-md-6">
                                <label>Kategori ID</label>
                                <input type="text" name="categoryId" id="formCategoryId" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Attributes</label>
                                <textarea name="attributes" id="formAttributes" class="form-control" rows="5" readonly></textarea>
                            </div>
                            <div class="col-12 mt-4">
                                <label>Görseller</label>
                                <div id="imageGallery" class="d-flex flex-wrap gap-2 border p-2 rounded bg-light">
                                </div>
                                <div class="input-group mt-2">
                                    <input type="url" class="form-control" id="newImageUrl" placeholder="Yeni görsel URL'si (https://...)">
                                    <button type="button" class="btn btn-outline-secondary" id="addImageBtn">Ekle</button>
                                </div>
                                <input type="hidden" name="images[]" id="imagesInput">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="newListingModal" tabindex="-1" aria-labelledby="newListingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="newListingModalLabel">Yeni Listing Oluştur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <div class="search-step">
                        <h6 class="border-bottom pb-2 mb-3">Adım 1: Ürün Kodu Arama</h6>
                        <div class="form-group mb-3">
                            <label for="productIdentifier" class="form-label">Ürün Kodu (IM-XXX)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="productIdentifier" placeholder="IM-123 gibi ürün kodu girin">
                                <button class="btn btn-outline-primary" type="button" id="searchProductBtn">
                                    <i class="fas fa-search"></i> Ara
                                </button>
                            </div>
                            <div class="form-text">Pimcore'da kayıtlı ürün kodunu girin.</div>
                        </div>
                        <div id="searchResults" class="mt-3 d-none">
                            <div class="alert alert-info" id="searchingMessage">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Aranıyor...</span>
                                    </div>
                                    <span>Ürün aranıyor, lütfen bekleyin...</span>
                                </div>
                            </div>
                            <div id="noResultsMessage" class="alert alert-warning d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i> Sonuç bulunamadı. Lütfen farklı bir ürün kodu deneyin.
                            </div>
                            <div id="productDetails" class="card d-none mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0" id="foundProductName">Ürün Adı</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 text-center">
                                            <img id="foundProductImage" src="" alt="Ürün Görseli" class="img-fluid product-image mb-2" style="max-height: 150px;">
                                        </div>
                                        <div class="col-md-8">
                                            <table class="table table-sm table-borderless">
                                                <tbody>
                                                <tr>
                                                    <th>Ürün Kodu:</th>
                                                    <td id="foundProductId"></td>
                                                </tr>
                                                <tr>
                                                    <th>IWASKU:</th>
                                                    <td id="foundProductIwasku"></td>
                                                </tr>
                                                <tr>
                                                    <th>Kategori:</th>
                                                    <td id="foundProductCategory"></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-white">
                                    <button type="button" class="btn btn-success" id="selectProductBtn">
                                        <i class="fas fa-check-circle me-2"></i>Bu ürünle devam et
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="variants-step d-none">
                        <h6 class="border-bottom pb-2 mb-3">Adım 2: Varyantları Seç</h6>
                        <div id="variantsContainer">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="selectAllVariants"></th>
                                        <th style="width: 60px;">Görsel</th>
                                        <th>Varyant</th>
                                        <th>IWASKU</th>
                                        <th>Renk</th>
                                        <th>Ebat</th>
                                        <th style="width: 120px;">Stok</th>
                                        <th style="width: 120px;">Fiyat (₺)</th>
                                    </tr>
                                    </thead>
                                    <tbody id="variantsList">
                                    <!-- Varyantlar burada dinamik olarak listelenecek -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="alert alert-warning d-none" id="noVariantsMessage">
                                <i class="fas fa-exclamation-triangle me-2"></i> Bu ürüne ait varyant bulunamadı.
                            </div>
                        </div>
                    </div>

                    <div class="category-step d-none">
                        <h6 class="border-bottom pb-2 mb-3">Adım 3: Çiçeksepeti Kategori Seçimi</h6>
                        <div class="form-group mb-3">
                            <label for="ciceksepetiCategorySelect" class="form-label">Kategori</label>
                            <select class="form-select" id="ciceksepetiCategorySelect">
                                <option value="">Kategori seçin</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-outline-primary d-none" id="backToProductBtn">
                        <i class="fas fa-arrow-left me-2"></i>Ürün Aramaya Dön
                    </button>
                    <button type="button" class="btn btn-outline-primary d-none" id="backToVariantsBtn">
                        <i class="fas fa-arrow-left me-2"></i>Varyantlara Dön
                    </button>
                    <button type="button" class="btn btn-primary d-none" id="continueToVariantsBtn">
                        <i class="fas fa-arrow-right me-2"></i>Varyantları Seç
                    </button>
                    <button type="button" class="btn btn-primary d-none" id="continueToCategoryBtn">
                        <i class="fas fa-arrow-right me-2"></i>Kategori Seç
                    </button>
                    <button type="button" class="btn btn-success d-none" id="createListingBtn">
                        <i class="fas fa-plus-circle me-2"></i>Listing Oluştur
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="checkListingModal" tabindex="-1" aria-labelledby="checkListingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="checkListingModalLabel">Listing Kontrol</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="checkIdentifier" class="form-label">Ürün Kodu veya IWASKU</label>
                        <input type="text" class="form-control" id="checkIdentifier" placeholder="Kontrol etmek istediğiniz ürün kodunu girin">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="checkListingSubmitBtn">Kontrol Et</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block stylesheets %}
    {{ parent() }}
    <style>
        .modal-dialog-scrollable .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-body {
            flex: 1 1 auto;
        }
        .product-card {
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .product-image-container {
            height: 200px;
            overflow: hidden;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .variant-image {
            width: 100%;
            height: 60px;
            object-fit: contain;
        }

        .variant-no-image {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .variant-count {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .no-image {
            background-color: #f8f9fa;
            color: #6c757d;
            padding: 20px;
        }

        .variants-container {
            max-height: 300px;
            overflow-y: auto;
        }
        #imageGallery .image-item {
            position: relative;
            width: 100px;
            height: 100px;
        }
        #imageGallery .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: .25rem;
        }
        #imageGallery .remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 0.75rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
{% endblock %}
{% block body_scripts %}
    {{ parent() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Varyant gösterme/gizleme butonları
            const toggleButtons = document.querySelectorAll('.toggle-variants');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mainCode = this.getAttribute('data-main-code');
                    const variantsContainer = document.querySelector(`.variants-container[data-main-code="${mainCode}"]`);
                    const icon = this.querySelector('.toggle-icon');

                    if (variantsContainer.classList.contains('d-none')) {
                        variantsContainer.classList.remove('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-up toggle-icon"></i> Varyantları Gizle';
                    } else {
                        variantsContainer.classList.add('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster';
                    }
                });
            });

            // Düzenleme modalı için verileri doldur
            document.querySelectorAll(".open-edit-modal").forEach(function (btn) {
                btn.addEventListener("click", function () {
                    document.getElementById("formProductName").value = this.dataset.productName || '';
                    document.getElementById("formProductCode").value = this.dataset.productCode || '';
                    document.getElementById("formBarcode").value = this.dataset.barcode || '';
                    document.getElementById("formStock").value = this.dataset.stock || '';
                    document.getElementById("formSalesPrice").value = this.dataset.salesPrice || '';
                    document.getElementById("formListPrice").value = this.dataset.listPrice || '';
                    document.getElementById("formDescription").value = this.dataset.description || '';
                    document.getElementById("formCategoryId").value = this.dataset.categoryId || '';
                    document.getElementById("formVariantActive").value = this.dataset.variantIsactive || '0';
                    document.getElementById("formProductActive").value = this.dataset.productIsactive || '0';
                    document.getElementById("formMainProductCode").value = this.dataset.mainProductCode || '';
                    document.getElementById("formStockCode").value = this.dataset.productStockCode || '';
                    document.getElementById("formCommissionRate").value = this.dataset.commissionRate || '0';
                    document.getElementById("formDeliveryType").value = this.dataset.deliveryType || '1';
                    document.getElementById("formDeliveryMessageType").value = this.dataset.deliveryMessageType || '1';

                    const attributes = this.dataset.attributes;
                    try {
                        const parsed = JSON.parse(attributes);
                        const formatted = JSON.stringify(parsed, null, 4);
                        document.getElementById("formAttributes").value = formatted;
                    } catch (e) {
                        document.getElementById("formAttributes").value = attributes;
                    }

                    // Görsel galerisi oluştur
                    const rawImages = this.dataset.images;
                    try {
                        currentImages = JSON.parse(rawImages);
                    } catch {
                        currentImages = rawImages ? [rawImages] : [];
                    }
                    updateImageGallery();
                });
            });

            // Görsel galerisi için kod
            let currentImages = [];

            function updateImageGallery() {
                const gallery = document.getElementById("imageGallery");
                gallery.innerHTML = "";

                currentImages.forEach((url, index) => {
                    const item = document.createElement("div");
                    item.className = "image-item";
                    item.setAttribute("data-index", index);

                    const img = document.createElement("img");
                    img.src = url;

                    const removeBtn = document.createElement("button");
                    removeBtn.className = "remove-btn";
                    removeBtn.innerHTML = "&times;";
                    removeBtn.addEventListener("click", () => {
                        currentImages.splice(index, 1);
                        updateImageGallery();
                    });

                    item.appendChild(img);
                    item.appendChild(removeBtn);
                    gallery.appendChild(item);
                });

                // Galeriyi sıralama için güncelle
                if (gallery.children.length > 0) {
                    Sortable.create(gallery, {
                        animation: 150,
                        onEnd: function (evt) {
                            const newOrder = [];
                            gallery.querySelectorAll(".image-item").forEach(item => {
                                const src = item.querySelector("img").src;
                                newOrder.push(src);
                            });
                            currentImages = newOrder;
                            document.getElementById("imagesInput").value = JSON.stringify(currentImages);
                        }
                    });
                }

                document.getElementById("imagesInput").value = JSON.stringify(currentImages);
            }

            // Yeni görsel ekleme butonu
            const addImageBtn = document.getElementById("addImageBtn");
            if (addImageBtn) {
                addImageBtn.addEventListener("click", () => {
                    const newUrl = document.getElementById("newImageUrl").value.trim();
                    if (newUrl.startsWith("https://")) {
                        currentImages.push(newUrl);
                        updateImageGallery();
                        document.getElementById("newImageUrl").value = "";
                    } else {
                        alert("Lütfen geçerli bir HTTPS URL girin.");
                    }
                });
            }

            // Variant form gönderimi
            const variantForm = document.getElementById('variantForm');
            if (variantForm) {
                variantForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    let formData = new FormData(event.target);

                    fetch('/variant/update', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Formdan gelen veriler:', data);
                            alert('Form başarıyla gönderildi. Veriler F12 konsolunda görüntülenebilir.');
                        })
                        .catch(error => {
                            console.error('Bir hata oluştu:', error);
                        });
                });
            }

            // YENİ LISTING OLUŞTURMA FONKSİYONLARI
            let selectedProduct = null;
            let selectedVariants = [];

            // Ürün arama butonuna tıklama olayı
            const searchProductBtn = document.getElementById('searchProductBtn');
            if (searchProductBtn) {
                searchProductBtn.addEventListener('click', function() {
                    searchProduct();
                });
            }

            // Enter tuşu ile arama
            const productIdentifierInput = document.getElementById('productIdentifier');
            if (productIdentifierInput) {
                productIdentifierInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchProduct();
                    }
                });
            }

            // Ürün arama fonksiyonu
            function searchProduct() {
                const productCode = document.getElementById('productIdentifier')?.value.trim();
                if (!productCode) {
                    alert('Lütfen bir ürün kodu girin');
                    return;
                }

                const modal = document.getElementById('newListingModal');
                if (modal && !modal.classList.contains('show')) {
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                }

                const searchResults = document.querySelector('#newListingModal #searchResults');
                const searchingMessage = document.querySelector('#newListingModal #searchingMessage');
                const noResultsMessage = document.querySelector('#newListingModal #noResultsMessage');
                const productDetails = document.querySelector('#newListingModal #productDetails');

                if (!searchResults || !searchingMessage || !noResultsMessage || !productDetails) {
                    console.error('Ürün arama için gereken DOM öğeleri bulunamadı:', {
                        searchResults: !!searchResults,
                        searchingMessage: !!searchingMessage,
                        noResultsMessage: !!noResultsMessage,
                        productDetails: !!productDetails
                    });
                    alert('Sayfa yapısında bir sorun oluştu. Lütfen sayfayı yenileyin ve tekrar deneyin.');
                    return;
                }

                searchResults.classList.remove('d-none');
                searchingMessage.classList.remove('d-none');
                noResultsMessage.classList.add('d-none');
                productDetails.classList.add('d-none');

                // API isteği
                fetch(`/api/products/search?identifier=${encodeURIComponent(productCode)}`)
                    .then(response => response.json())
                    .then(data => {
                        // Arama sonuçlarını göster
                        searchingMessage.classList.add('d-none');

                        if (data.success && data.product) {
                            // Ürün bulundu, bilgileri sakla
                            selectedProduct = data.product;

                            // UI'ı güncelle
                            document.getElementById('foundProductName').textContent = data.product.name || 'İsimsiz Ürün';
                            document.getElementById('foundProductId').textContent = data.product.id || '-';
                            document.getElementById('foundProductCategory').textContent = data.product.productCategory || '-';

                            // Varyant sayısını kontrol et ve göster
                            const variantCount = data.product.variants ? data.product.variants.length : 0;
                            document.getElementById('foundProductIwasku').textContent =
                                variantCount > 0 ? data.product.variants[0].iwasku || '-' : '-';

                            // Detayları ve devam butonunu göster
                            productDetails.classList.remove('d-none');
                            const continueBtn = document.getElementById('continueToVariantsBtn');
                            if (continueBtn) {
                                continueBtn.classList.remove('d-none');
                            }
                        } else {
                            // Ürün bulunamadı
                            noResultsMessage.classList.remove('d-none');
                            const continueBtn = document.getElementById('continueToVariantsBtn');
                            if (continueBtn) {
                                continueBtn.classList.add('d-none');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Ürün arama hatası:', error);
                        searchingMessage.classList.add('d-none');
                        noResultsMessage.classList.remove('d-none');
                        const continueBtn = document.getElementById('continueToVariantsBtn');
                        if (continueBtn) {
                            continueBtn.classList.add('d-none');
                        }
                    });
            }

            // Ürün seçme ve devam butonları
            const selectProductBtn = document.getElementById('selectProductBtn');
            if (selectProductBtn) {
                selectProductBtn.addEventListener('click', function() {
                    if (selectedProduct) {
                        showVariantsStep();
                    }
                });
            }

            const continueToVariantsBtn = document.getElementById('continueToVariantsBtn');
            if (continueToVariantsBtn) {
                continueToVariantsBtn.addEventListener('click', function() {
                    if (selectedProduct) {
                        showVariantsStep();
                    }
                });
            }

            // Varyant adımını göster
            function showVariantsStep() {
                // UI öğelerini doğrula
                const searchStep = document.querySelector('.search-step');
                const variantsStep = document.querySelector('.variants-step');

                if (!searchStep || !variantsStep) {
                    console.error('Adım öğeleri bulunamadı.');
                    return;
                }

                // Adımları değiştir
                searchStep.classList.add('d-none');
                variantsStep.classList.remove('d-none');

                // Butonları güncelle
                const continueToVariantsBtn = document.getElementById('continueToVariantsBtn');
                const backToProductBtn = document.getElementById('backToProductBtn');
                const continueToCategoryBtn = document.getElementById('continueToCategoryBtn');

                if (continueToVariantsBtn) continueToVariantsBtn.classList.add('d-none');
                if (backToProductBtn) backToProductBtn.classList.remove('d-none');
                if (continueToCategoryBtn) continueToCategoryBtn.classList.remove('d-none');

                // Varyantları listele
                renderVariants(selectedProduct.variants);
            }

            // Varyantları listele
            function renderVariants(variants) {
                const variantsList = document.getElementById('variantsList');
                const noVariantsMessage = document.getElementById('noVariantsMessage');

                if (!variantsList || !noVariantsMessage) {
                    console.error('Varyant listesi öğeleri bulunamadı.');
                    return;
                }

                // Varyant listesini temizle
                variantsList.innerHTML = '';

                if (variants && variants.length > 0) {
                    // Varyantları listele
                    variants.forEach((variant, index) => {
                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <td><input type="checkbox" class="variant-checkbox" value="${variant.id}" id="variant_${variant.id}"></td>
                            <td><div class="bg-light text-center" style="height: 40px; width: 40px;"><i class="fas fa-image text-muted pt-2"></i></div></td>
                            <td>${variant.id}</td>
                            <td>${variant.iwasku || '-'}</td>
                            <td>${variant.variationColor || '-'}</td>
                            <td>${variant.variationSize || '-'}</td>
                            <td><input type="number" class="form-control form-control-sm" id="stock_${variant.id}" value="10" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="price_${variant.id}" value="100" min="0" step="0.01"></td>
                        `;

                        variantsList.appendChild(row);
                    });

                    noVariantsMessage.classList.add('d-none');
                } else {
                    // Varyant yok mesajı
                    noVariantsMessage.classList.remove('d-none');
                }
            }

            // Tüm varyantları seç/kaldır
            const selectAllVariants = document.getElementById('selectAllVariants');
            if (selectAllVariants) {
                selectAllVariants.addEventListener('change', function() {
                    const isChecked = this.checked;
                    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                });
            }

            // Ürün aramaya dön butonu
            const backToProductBtn = document.getElementById('backToProductBtn');
            if (backToProductBtn) {
                backToProductBtn.addEventListener('click', function() {
                    // Adımları değiştir
                    const searchStep = document.querySelector('.search-step');
                    const variantsStep = document.querySelector('.variants-step');
                    const categoryStep = document.querySelector('.category-step');

                    if (searchStep) searchStep.classList.remove('d-none');
                    if (variantsStep) variantsStep.classList.add('d-none');
                    if (categoryStep) categoryStep.classList.add('d-none');

                    // Butonları güncelle
                    const continueToVariantsBtn = document.getElementById('continueToVariantsBtn');
                    const backToProductBtn = document.getElementById('backToProductBtn');
                    const continueToCategoryBtn = document.getElementById('continueToCategoryBtn');
                    const backToVariantsBtn = document.getElementById('backToVariantsBtn');
                    const createListingBtn = document.getElementById('createListingBtn');

                    if (continueToVariantsBtn) continueToVariantsBtn.classList.remove('d-none');
                    if (backToProductBtn) backToProductBtn.classList.add('d-none');
                    if (continueToCategoryBtn) continueToCategoryBtn.classList.add('d-none');
                    if (backToVariantsBtn) backToVariantsBtn.classList.add('d-none');
                    if (createListingBtn) createListingBtn.classList.add('d-none');
                });
            }

            // Kategori adımına geç butonu
            const continueToCategoryBtn = document.getElementById('continueToCategoryBtn');
            if (continueToCategoryBtn) {
                continueToCategoryBtn.addEventListener('click', function() {
                    // Varyant seçim kontrolü
                    const selectedCheckboxes = document.querySelectorAll('.variant-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        alert('Lütfen en az bir varyant seçin');
                        return;
                    }

                    // Seçilen varyantları kaydet
                    selectedVariants = [];
                    selectedCheckboxes.forEach(checkbox => {
                        selectedVariants.push({
                            id: checkbox.value,
                            price: document.getElementById(`price_${checkbox.value}`).value,
                            stock: document.getElementById(`stock_${checkbox.value}`).value
                        });
                    });

                    // Adımları değiştir
                    const variantsStep = document.querySelector('.variants-step');
                    const categoryStep = document.querySelector('.category-step');

                    if (variantsStep) variantsStep.classList.add('d-none');
                    if (categoryStep) categoryStep.classList.remove('d-none');

                    // Butonları güncelle
                    const continueToCategoryBtn = document.getElementById('continueToCategoryBtn');
                    const backToProductBtn = document.getElementById('backToProductBtn');
                    const backToVariantsBtn = document.getElementById('backToVariantsBtn');
                    const createListingBtn = document.getElementById('createListingBtn');

                    if (continueToCategoryBtn) continueToCategoryBtn.classList.add('d-none');
                    if (backToProductBtn) backToProductBtn.classList.add('d-none');
                    if (backToVariantsBtn) backToVariantsBtn.classList.remove('d-none');
                    if (createListingBtn) createListingBtn.classList.remove('d-none');
                });
            }

            // Varyantlara dön butonu
            const backToVariantsBtn = document.getElementById('backToVariantsBtn');
            if (backToVariantsBtn) {
                backToVariantsBtn.addEventListener('click', function() {
                    // Adımları değiştir
                    const variantsStep = document.querySelector('.variants-step');
                    const categoryStep = document.querySelector('.category-step');

                    if (variantsStep) variantsStep.classList.remove('d-none');
                    if (categoryStep) categoryStep.classList.add('d-none');

                    // Butonları güncelle
                    const continueToCategoryBtn = document.getElementById('continueToCategoryBtn');
                    const backToProductBtn = document.getElementById('backToProductBtn');
                    const backToVariantsBtn = document.getElementById('backToVariantsBtn');
                    const createListingBtn = document.getElementById('createListingBtn');

                    if (continueToCategoryBtn) continueToCategoryBtn.classList.remove('d-none');
                    if (backToProductBtn) backToProductBtn.classList.remove('d-none');
                    if (backToVariantsBtn) backToVariantsBtn.classList.add('d-none');
                    if (createListingBtn) createListingBtn.classList.add('d-none');
                });
            }

            // Listing oluştur butonu
            const createListingBtn = document.getElementById('createListingBtn');
            if (createListingBtn) {
                createListingBtn.addEventListener('click', function() {
                    const categorySelect = document.getElementById('ciceksepetiCategorySelect');
                    if (!categorySelect) {
                        console.error('Kategori seçim elementi bulunamadı.');
                        return;
                    }

                    const categoryId = categorySelect.value;
                    if (!categoryId) {
                        alert('Lütfen bir kategori seçin');
                        return;
                    }

                    if (selectedVariants.length === 0) {
                        alert('Lütfen en az bir varyant seçin');
                        return;
                    }

                    // Butonu devre dışı bırak ve loading durumunu göster
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> İşleniyor...';

                    // Listing oluşturma isteği
                    fetch('/api/ciceksepeti/listing/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            productId: selectedProduct.id,
                            categoryId: categoryId,
                            variants: selectedVariants
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Butonu normal haline getir
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Listing Oluştur';

                            if (data.success) {
                                // Modal'ı kapat
                                const modal = bootstrap.Modal.getInstance(document.getElementById('newListingModal'));
                                if (modal) {
                                    modal.hide();
                                }

                                // Başarı mesajı
                                alert('Listing başarıyla oluşturuldu!');

                                // Sayfayı yenile
                                window.location.reload();
                            } else {
                                alert('Listing oluşturulurken bir hata oluştu: ' + (data.message || 'Bilinmeyen hata'));
                            }
                        })
                        .catch(error => {
                            console.error('Listing oluşturma hatası:', error);
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Listing Oluştur';
                            alert('Listing oluşturulurken bir hata oluştu. Lütfen tekrar deneyin.');
                        });
                });
            }

            // Listing kontrol butonu
            const checkListingSubmitBtn = document.getElementById('checkListingSubmitBtn');
            if (checkListingSubmitBtn) {
                checkListingSubmitBtn.addEventListener('click', function() {
                    const checkIdentifier = document.getElementById('checkIdentifier');
                    if (!checkIdentifier) {
                        console.error('Ürün kodu input elementi bulunamadı.');
                        return;
                    }

                    const identifier = checkIdentifier.value.trim();
                    if (!identifier) {
                        alert('Lütfen bir ürün kodu veya IWASKU girin');
                        return;
                    }

                    // Butonu devre dışı bırak
                    this.disabled = true;
                    this.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div> Kontrol Ediliyor...';

                    // Kontrol isteği
                    fetch(`/api/ciceksepeti/listing/check?identifier=${encodeURIComponent(identifier)}`)
                        .then(response => response.json())
                        .then(data => {
                            this.disabled = false;
                            this.innerHTML = 'Kontrol Et';

                            const modal = bootstrap.Modal.getInstance(document.getElementById('checkListingModal'));
                            if (modal) {
                                modal.hide();
                            }

                            if (data.success && data.listings && data.listings.length > 0) {
                                alert(`${data.listings.length} adet listing bulundu. Detaylar için konsola bakın.`);
                                console.log('Bulunan listingler:', data.listings);
                            } else {
                                alert('Bu ürün koduna ait listing bulunamadı.');
                            }
                        })
                        .catch(error => {
                            console.error('Listing kontrol hatası:', error);
                            this.disabled = false;
                            this.innerHTML = 'Kontrol Et';
                            alert('İşlem sırasında bir hata oluştu. Lütfen tekrar deneyin.');
                        });
                });
            }

            // Modal kapatıldığında formu sıfırla
            const newListingModal = document.getElementById('newListingModal');
            if (newListingModal) {
                newListingModal.addEventListener('hidden.bs.modal', function () {
                    // Form alanlarını sıfırla
                    const productIdentifier = document.getElementById('productIdentifier');
                    if (productIdentifier) productIdentifier.value = '';

                    const searchResults = document.getElementById('searchResults');
                    if (searchResults) searchResults.classList.add('d-none');

                    // Adımları sıfırla
                    const searchStep = document.querySelector('.search-step');
                    const variantsStep = document.querySelector('.variants-step');
                    const categoryStep = document.querySelector('.category-step');

                    if (searchStep) searchStep.classList.remove('d-none');
                    if (variantsStep) variantsStep.classList.add('d-none');
                    if (categoryStep) categoryStep.classList.add('d-none');

                    // Butonları sıfırla
                    const continueToVariantsBtn = document.getElementById('continueToVariantsBtn');
                    const backToProductBtn = document.getElementById('backToProductBtn');
                    const continueToCategoryBtn = document.getElementById('continueToCategoryBtn');
                    const backToVariantsBtn = document.getElementById('backToVariantsBtn');
                    const createListingBtn = document.getElementById('createListingBtn');

                    if (continueToVariantsBtn) continueToVariantsBtn.classList.add('d-none');
                    if (backToProductBtn) backToProductBtn.classList.add('d-none');
                    if (continueToCategoryBtn) continueToCategoryBtn.classList.add('d-none');
                    if (backToVariantsBtn) backToVariantsBtn.classList.add('d-none');
                    if (createListingBtn) createListingBtn.classList.add('d-none');

                    // Değişkenleri sıfırla
                    selectedProduct = null;
                    selectedVariants = [];
                });
            }
        });
    </script>
{% endblock %}
