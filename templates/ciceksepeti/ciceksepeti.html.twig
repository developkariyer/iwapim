{% extends 'base.html.twig' %}
{% block title %} Çiçeksepeti {% endblock %}
{% block navbaritems %}{% endblock %}
{% block header %}{% endblock %}

{% block content %}
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">Çiçeksepeti Ürünleri</h1>

        <!-- Başarılı mesajlar -->
        {% for message in app.flashes('success') %}
            <div class="alert alert-success">
                {{ message }}
            </div>
        {% endfor %}

        <div class="row">
            <!-- Sol Kenar Çubuğu - Kategori Listesi -->
            <div class="col-md-3 col-12 mb-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Çiçeksepeti Kategorileri</h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Kategori güncelleme butonu -->
                        <div class="p-3 border-bottom">
                            <form method="post" action="{{ path('update_category') }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-sync-alt me-2"></i> Kategorileri Güncelle
                                </button>
                            </form>
                        </div>

                        <!-- Kategori listesi -->
                        <div class="list-group list-group-flush">
                            <a href="{{ path('ciceksepeti_main_page') }}"
                               class="list-group-item list-group-item-action {% if app.request.get('category') is null %}active{% endif %}">
                                Tüm Kategoriler
                            </a>
                            {% for category in categories %}
                                <a href="{{ path('ciceksepeti_main_page', {'category': category.id}) }}"
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if app.request.get('category') == category.id %}active{% endif %}"
                                   data-id="{{ category.id }}">
                                    <span>{{ category.name }}</span>
                                    {% if category.count is defined %}
                                        <span class="badge bg-primary rounded-pill">{{ category.count }}</span>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Ana İçerik - Ürünler ve Varyantlar -->
            <div class="col-md-9 col-12">
                <div class="row mb-3">
                    <div class="col-6">
                        <button type="button" class="btn btn-primary w-100" id="newListingBtn">
                            <i class="fas fa-plus-circle me-2"></i>Yeni Listing
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-primary w-100" id="checkListingBtn">
                            <i class="fas fa-search me-2"></i>Listing Kontrol
                        </button>
                    </div>
                </div>
                {% if app.request.get('category') %}
                    <div class="alert alert-info mb-4">
                        <strong>Kategori:</strong>
                        {% for category in categories %}
                            {% if category.id == app.request.get('category') %}
                                {{ category.name }}
                            {% endif %}
                        {% endfor %}
                        <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-sm btn-outline-secondary float-end">
                            <i class="fas fa-times"></i> Filtreyi Temizle
                        </a>
                    </div>
                {% endif %}

                {% if grouped|length > 0 %}
                    <div class="row" id="productList">
                        {% for mainCode, listings in grouped %}
                            {% set firstProduct = listings|first %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card product-card h-100">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0 text-truncate">{{ firstProduct.productName|default('Ürün ' ~ mainCode) }}</h5>
                                        <small class="text-muted">Ana Kod: {{ mainCode }}</small>
                                    </div>
                                    <div class="card-body p-0">
                                        <!-- Ürün görseli -->
                                        <div class="p-2 text-center product-image-container">
                                            {% if firstProduct.images is defined and firstProduct.images|length > 0 %}
                                                <img src="{{ firstProduct.images[0] }}" class="img-fluid product-image" alt="{{ firstProduct.productName }}">
                                            {% else %}
                                                <div class="no-image p-5 bg-light text-center">
                                                    <i class="fas fa-image fa-3x text-muted"></i>
                                                    <p class="mt-2 mb-0">Görsel yok</p>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Varyant sayısı -->
                                        <div class="variant-count p-2 bg-light border-top border-bottom">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-cubes me-1"></i> {{ listings|length }} varyant
                                            </span>
                                        </div>

                                        <!-- Varyant listesi (kapalı başlıyor) -->
                                        <div class="variants-container border-bottom d-none" data-main-code="{{ mainCode }}">
                                            <div class="list-group list-group-flush">
                                                {% for variant in listings %}
                                                    <div class="list-group-item p-2">
                                                        <div class="row g-0">
                                                            <div class="col-3">
                                                                {% if variant.images is defined and variant.images|length > 0 %}
                                                                    <a href="{{ variant.link }}" target="_blank"><img src="{{ variant.images[0] }}" class="img-fluid variant-image" alt="{{ variant.productName }}"></a>
                                                                {% else %}
                                                                    <div class="variant-no-image text-center">
                                                                        <i class="fas fa-image text-muted"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-9">
                                                                <div class="ps-2">
                                                                    <h6 class="mb-1 text-truncate">{{ variant.productName|default('İsimsiz Varyant') }}</h6>
                                                                    <small class="d-block text-muted">Ürün Kodu: {{ variant.productCode|default('-') }}</small>
                                                                    <small class="d-block text-muted">Stok: {{ variant.stockQuantity|default(0) }}</small>
                                                                    <small class="d-block text-muted">Favori: {{ variant.numberOfFavorites|default(0) }}</small>
                                                                    <div class="mt-1">
                                                                        <span class="badge bg-primary">{{ variant.salesPrice|default('-') }} TL</span>
                                                                        {% if variant.variantIsActive %}
                                                                            <span class="badge bg-success">Aktif</span>
                                                                        {% else %}
                                                                            <span class="badge bg-danger">Pasif</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    <button
                                                                            class="btn btn-sm btn-outline-primary mt-2 open-edit-modal"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#editModal"
                                                                            data-product-link="{{ variant.link }}"
                                                                            data-product-name="{{ variant.productName }}"
                                                                            data-product-code="{{ variant.productCode }}"
                                                                            data-product-stock-code="{{ variant.stockCode }}"
                                                                            data-barcode="{{ variant.barcode }}"
                                                                            data-stock="{{ variant.stockQuantity }}"
                                                                            data-attributes="{{ variant.attributes|json_encode|e('html_attr') }}"
                                                                            data-delivery-type="{{ variant.deliveryType }}"
                                                                            data-delivery-message-type="{{ variant.deliveryMessageType }}"
                                                                            data-commission-rate="{{ variant.commissionRate }}"
                                                                            data-main-product-code="{{ variant.mainProductCode }}"
                                                                            data-sales-price="{{ variant.salesPrice }}"
                                                                            data-list-price="{{ variant.listPrice }}"
                                                                            data-description="{{ variant.description }}"
                                                                            data-category-id="{{ variant.categoryId }}"
                                                                            data-variant-isactive="{{ variant.variantIsActive ? '1' : '0' }}"
                                                                            data-product-isactive="{{ variant.productIsActive }}"
                                                                            data-images="{{ variant.images|json_encode|e('html_attr') }}"
                                                                    >
                                                                        Düzenle
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer text-center">
                                        <button class="btn btn-sm btn-outline-primary toggle-variants" data-main-code="{{ mainCode }}">
                                            <i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            {% if app.request.get('category') %}
                                <h4>Bu kategoride ürün bulunamadı</h4>
                                <p class="mb-3">Başka bir kategori seçmeyi deneyebilir veya tüm ürünleri görüntüleyebilirsiniz.</p>
                                <a href="{{ path('ciceksepeti_main_page') }}" class="btn btn-primary">
                                    Tüm Ürünleri Göster
                                </a>
                            {% else %}
                                <h4>Hiç ürün bulunamadı</h4>
                                <p>Lütfen daha sonra tekrar deneyin veya sistem yöneticinize başvurun.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-12 mt-3">
        <h4>Batch ID'leri</h4>
        <ul id="batchList" class="list-group">
        </ul>
    </div>

    <!-- Düzenleme Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <form id="variantForm" method="post" action="/variant/update">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Varyant Düzenle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label>Ürün Adı (Title)</label>
                                <input type="text" name="productName" id="formProductName" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Ana Ürün Kodu (PIM Identifier)</label>
                                <input type="text" name="mainProductCode" id="formMainProductCode" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Stok Kodu (IWASKU)</label>
                                <input type="text" name="stockCode" id="formStockCode" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Barkod (EAN)</label>
                                <input type="text" name="barcode" id="formBarcode" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Ürün Kodu (Ciceksepeti Product Code)</label>
                                <input type="text" name="productCode" id="formProductCode" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Satış Fiyatı (TL)</label>
                                <input type="text" name="salesPrice" id="formSalesPrice" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Liste Fiyatı (Üstü Çizili Fiyat TL)</label>
                                <input type="text" name="listPrice" id="formListPrice" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Stok Miktarı</label>
                                <input type="number" name="stockQuantity" id="formStock" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label>Komisyon Oranı</label>
                                <input type="text" name="commissionRate" id="formCommissionRate" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Teslimat Tipi</label>
                                <input type="text" name="deliveryType" id="formDeliveryType" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Teslimat Aralığı</label>
                                <input type="text" name="deliveryMessageType" id="formDeliveryMessageType" class="form-control" readonly>
                            </div>
                            <div class="col-12">
                                <label>Açıklama</label>
                                <textarea name="description" id="formDescription" class="form-control" rows="3" ></textarea>
                            </div>
                            <div class="col-md-6">
                                <label>Listing Aktif mi?</label>
                                <input type="text" name="productIsActive" id="formProductActive" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Variant Aktif mi?</label>
                                <input type="number" name="variantIsActive" id="formVariantActive" class="form-control" min="0" max="1" value="1">
                            </div>
                            <div class="col-md-6">
                                <label>Kategori ID</label>
                                <input type="text" name="categoryId" id="formCategoryId" class="form-control" readonly>
                            </div>
                            <div class="col-md-6">
                                <label>Attributes</label>
                                <textarea name="attributes" id="formAttributes" class="form-control" rows="5" readonly></textarea>
                            </div>
                            <div class="col-12 mt-4">
                                <label>Görseller</label>
                                <div id="imageGallery" class="d-flex flex-wrap gap-2 border p-2 rounded bg-light">
                                </div>
                                <div class="input-group mt-2">
                                    <input type="url" class="form-control" id="newImageUrl" placeholder="Yeni görsel URL'si (https://...)">
                                    <button type="button" class="btn btn-outline-secondary" id="addImageBtn">Ekle</button>
                                </div>
                                <input type="hidden" name="images[]" id="imagesInput">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Yeni Listing Modal -->
    <div class="modal fade" id="newListingModal" tabindex="-1" aria-labelledby="newListingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="newListingModalLabel">Yeni Listing Oluştur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <!-- Arama Formu -->
                    <div class="mb-3">
                        <label for="productIdentifier" class="form-label">Ürün Kodu (PIM)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="productIdentifier" placeholder="Örn: CA-001A">
                            <button class="btn btn-primary" type="button" id="searchBtn">
                                <i class="fas fa-search"></i> Ara
                            </button>
                        </div>
                        <small class="form-text text-muted">Aramak istediğiniz ana ürün kodunu girin.</small>
                    </div>

                    <div id="searchResultsContainer" class="mt-4 d-none">
                        <!-- Yükleniyor animasyonu -->
                        <div id="loadingSpinner" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                            <p class="mt-2">Sonuçlar yükleniyor...</p>
                        </div>

                        <!-- Hata mesajı -->
                        <div id="errorMessage" class="alert alert-danger d-none"></div>

                        <!-- Ürün bilgileri -->
                        <div id="productInfo" class="d-none">
                            <div class="alert alert-success mb-3">
                                <h5 id="productName" class="mb-1">Ürün Adı</h5>
                                <div><strong>Ürün ID:</strong> <span id="productId"></span></div>
                                <div><strong>Kategori:</strong> <span id="productCategory"></span></div>
                            </div>

                            <!-- Listing kategorisi seçimi -->
                            <div class="mb-4">
                                <label for="categorySelect" class="form-label">Çiçeksepeti Kategorisi</label>
                                <select class="form-select" id="categorySelect">
                                    <option value="">Kategori Seçin</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Varyantlar ve varyant seçimi -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Varyantlar</h5>

                                    <!-- Toplu işlemler -->
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllVariantsBtn">
                                            <i class="fas fa-check-square me-1"></i> Tümünü Seç
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllVariantsBtn">
                                            <i class="fas fa-square me-1"></i> Seçimi Kaldır
                                        </button>
                                    </div>
                                </div>

                                <!-- Toplu stok ve fiyat ayarları -->
                                <div class="row g-2 mb-3 p-2 bg-light border rounded">
                                    <div class="col-md-6">
                                        <label class="form-label small">Toplu Stok Ayarla</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="bulkStock" value="10" min="1">
                                            <button class="btn btn-outline-primary" type="button" id="applyBulkStock" title="Seçili varyantlara uygula">
                                                <i class="fas fa-check"></i> Uygula
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Toplu Fiyat Ayarla</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="bulkPrice" value="100" min="0.01" step="0.01">
                                            <button class="btn btn-outline-primary" type="button" id="applyBulkPrice" title="Seçili varyantlara uygula">
                                                <i class="fas fa-check"></i> Uygula
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Varyant listesi tablosu -->
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover table-sm">
                                        <thead class="table-light">
                                        <tr>
                                            <th style="width: 40px;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="selectAllVariants">
                                                </div>
                                            </th>
                                            <th style="width: 60px;">ID</th>
                                            <th>IWASKU</th>
                                            <th>Renk</th>
                                            <th>Ebat</th>
                                            <th style="width: 70px;">Stok</th>
                                            <th style="width: 90px;">Fiyat (TL)</th>
                                        </tr>
                                        </thead>
                                        <tbody id="variantsTableBody">
                                        <!-- Varyantlar burada listelenecek -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Seçim bilgisi -->
                                <div class="mt-2 text-end text-muted">
                                    <small id="selectionInfo">0 varyant seçildi</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-success" id="createListingBtn" disabled>
                        <i class="fas fa-plus-circle me-1"></i> Listing Oluştur
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Modal Stilleri */
        .modal-dialog-scrollable .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-xl .modal-body {
            max-height: 65vh;
            overflow-y: auto;
        }

        .modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-body {
            flex: 1 1 auto;
        }

        /* Ürün Kart Stilleri */
        .product-card {
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .product-image-container {
            height: 200px;
            overflow: hidden;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .variant-image {
            width: 100%;
            height: 60px;
            object-fit: contain;
        }

        .variant-no-image {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
        }

        .variant-count {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .no-image {
            background-color: #f8f9fa;
            color: #6c757d;
            padding: 20px;
        }

        .variants-container {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Görsel Galerisi Stilleri */
        #imageGallery .image-item {
            position: relative;
            width: 100px;
            height: 100px;
        }

        #imageGallery .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: .25rem;
        }

        #imageGallery .remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 0.75rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Geliştirilmiş varyant tablosu stil */
        #variantsTableBody tr:hover {
            background-color: rgba(0,123,255,0.05);
        }

        /* Seçili tablo satırı stillendirmesi */
        #variantsTableBody tr.selected-row {
            background-color: rgba(0,123,255,0.15);
        }

        /* Tablo responsive düzenlemeleri */
        .table-responsive {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Toast bildirimi stili */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
{% endblock %}

{% block body_scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        document.getElementById('checkListingBtn').addEventListener('click', function () {
            fetch('/listing/batch-ids')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ağ hatası: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const batchList = document.getElementById('batchList');
                    batchList.innerHTML = '';  

                    if (data.success) {
                        data.product.forEach(item => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('list-group-item');
                            listItem.textContent = item.batchId;
                            batchList.appendChild(listItem);
                        });
                    } else {
                        const errorMessage = document.createElement('li');
                        errorMessage.classList.add('list-group-item', 'list-group-item-danger');
                        errorMessage.textContent = 'Veri alınırken bir sorun oluştu.';
                        batchList.appendChild(errorMessage);
                    }
                })
                .catch(error => {
                    const batchList = document.getElementById('batchList');
                    const errorMessage = document.createElement('li');
                    errorMessage.classList.add('list-group-item', 'list-group-item-danger');
                    errorMessage.textContent = 'Hata oluştu: ' + error.message;
                    batchList.appendChild(errorMessage);
                });
        });


        document.addEventListener('DOMContentLoaded', function() {
            // ----- MEVCUT VARYANT YÖNETİMİ İŞLEVLERİ ----- //

            /**
             * Varyant Görüntüleme Açma/Kapama
             * Ürün kartındaki varyant listesini açıp kapatır
             */
            const toggleButtons = document.querySelectorAll('.toggle-variants');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const mainCode = this.getAttribute('data-main-code');
                    const variantsContainer = document.querySelector(`.variants-container[data-main-code="${mainCode}"]`);

                    if (variantsContainer.classList.contains('d-none')) {
                        variantsContainer.classList.remove('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-up toggle-icon"></i> Varyantları Gizle';
                    } else {
                        variantsContainer.classList.add('d-none');
                        this.innerHTML = '<i class="fas fa-chevron-down toggle-icon"></i> Varyantları Göster';
                    }
                });
            });

            /**
             * Düzenleme Modal Formunu Doldurma
             * Varyant düzenleme butonuna tıklandığında verileri forma yükler
             */
            document.querySelectorAll(".open-edit-modal").forEach(function (btn) {
                btn.addEventListener("click", function () {
                    document.getElementById("formProductName").value = this.dataset.productName || '';
                    document.getElementById("formProductCode").value = this.dataset.productCode || '';
                    document.getElementById("formBarcode").value = this.dataset.barcode || '';
                    document.getElementById("formStock").value = this.dataset.stock || '';
                    document.getElementById("formSalesPrice").value = this.dataset.salesPrice || '';
                    document.getElementById("formListPrice").value = this.dataset.listPrice || '';
                    document.getElementById("formDescription").value = this.dataset.description || '';
                    document.getElementById("formCategoryId").value = this.dataset.categoryId || '';
                    document.getElementById("formVariantActive").value = this.dataset.variantIsactive || '0';
                    document.getElementById("formProductActive").value = this.dataset.productIsactive || '0';
                    document.getElementById("formMainProductCode").value = this.dataset.mainProductCode || '';
                    document.getElementById("formStockCode").value = this.dataset.productStockCode || '';
                    document.getElementById("formCommissionRate").value = this.dataset.commissionRate || '0';
                    document.getElementById("formDeliveryType").value = this.dataset.deliveryType || '1';
                    document.getElementById("formDeliveryMessageType").value = this.dataset.deliveryMessageType || '1';

                    // JSON verisini formatlı göster
                    try {
                        const attributes = JSON.parse(this.dataset.attributes || '{}');
                        document.getElementById("formAttributes").value = JSON.stringify(attributes, null, 4);
                    } catch (e) {
                        document.getElementById("formAttributes").value = this.dataset.attributes || '';
                    }

                    // Görselleri yükle
                    try {
                        currentImages = JSON.parse(this.dataset.images || '[]');
                    } catch (e) {
                        currentImages = this.dataset.images ? [this.dataset.images] : [];
                    }
                    updateImageGallery();
                });
            });

            /**
             * Görsel Galerisi İşlemleri
             * Düzenleme modülünde görsel ekleyip düzenlemek için
             */
            let currentImages = [];

            // Görsel galerisini güncelleme fonksiyonu
            function updateImageGallery() {
                const gallery = document.getElementById("imageGallery");
                gallery.innerHTML = "";

                currentImages.forEach((url, index) => {
                    const item = document.createElement("div");
                    item.className = "image-item";
                    item.setAttribute("data-index", index);

                    const img = document.createElement("img");
                    img.src = url;

                    const removeBtn = document.createElement("button");
                    removeBtn.className = "remove-btn";
                    removeBtn.innerHTML = "&times;";
                    removeBtn.addEventListener("click", () => {
                        currentImages.splice(index, 1);
                        updateImageGallery();
                    });

                    item.appendChild(img);
                    item.appendChild(removeBtn);
                    gallery.appendChild(item);
                });

                // Galeriyi sıralama için güncelle
                if (gallery.children.length > 0) {
                    Sortable.create(gallery, {
                        animation: 150,
                        onEnd: function (evt) {
                            const newOrder = [];
                            gallery.querySelectorAll(".image-item").forEach(item => {
                                const src = item.querySelector("img").src;
                                newOrder.push(src);
                            });
                            currentImages = newOrder;
                            document.getElementById("imagesInput").value = JSON.stringify(currentImages);
                        }
                    });
                }

                document.getElementById("imagesInput").value = JSON.stringify(currentImages);
            }

            // Görsel ekle butonu
            document.getElementById("addImageBtn").addEventListener("click", () => {
                const newUrl = document.getElementById("newImageUrl").value.trim();
                if (newUrl.startsWith("https://")) {
                    currentImages.push(newUrl);
                    updateImageGallery();
                    document.getElementById("newImageUrl").value = "";
                } else {
                    alert("Lütfen geçerli bir HTTPS URL girin.");
                }
            });

            // Varyant formu gönderimi
            document.getElementById('variantForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);

                fetch('/variant/update', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Güncelleme yanıtı:', data);
                        alert('Varyant başarıyla güncellendi.');
                    })
                    .catch(error => {
                        console.error('Güncelleme hatası:', error);
                        alert('Güncellerken bir hata oluştu.');
                    });
            });

            // ----- YENİ LISTING OLUŞTURMA İŞLEVLERİ ----- //

            /**
             * Listing Modalı Açma
             * Yeni listing oluşturmak için modalı açar ve gerektiğinde formları sıfırlar
             */
            let isModalFirstOpen = true;

            document.getElementById('newListingBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('newListingModal'));

                if (isModalFirstOpen) {
                    // Form alanlarını sıfırla
                    document.getElementById('productIdentifier').value = '';
                    const resultsContainer = document.getElementById('searchResultsContainer');
                    const errorMessage = document.getElementById('errorMessage');
                    const productInfo = document.getElementById('productInfo');

                    if (resultsContainer) resultsContainer.classList.add('d-none');
                    if (errorMessage) errorMessage.classList.add('d-none');
                    if (productInfo) productInfo.classList.add('d-none');

                    isModalFirstOpen = false;
                }

                modal.show();
            });

            // Modal kapandığında değişkeni sıfırla
            document.getElementById('newListingModal').addEventListener('hidden.bs.modal', function () {
                isModalFirstOpen = true;
            });

            /**
             * Ürün Arama İşlemi
             * PIM'den ürün bilgilerini API üzerinden getirir
             */
            document.getElementById('searchBtn').addEventListener('click', searchProduct);

            // Enter tuşuyla da arama yapabilme
            document.getElementById('productIdentifier').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchProduct();
                }
            });

            // Ürün arama işlevi
            function searchProduct() {
                const identifier = document.getElementById('productIdentifier').value.trim();

                if (!identifier) {
                    alert('Lütfen bir ürün kodu girin');
                    return;
                }

                // UI elemanlarını hazırla
                const resultsContainer = document.getElementById('searchResultsContainer');
                const loadingSpinner = document.getElementById('loadingSpinner');
                const errorMessage = document.getElementById('errorMessage');
                const productInfo = document.getElementById('productInfo');

                if (resultsContainer) resultsContainer.classList.remove('d-none');
                if (loadingSpinner) loadingSpinner.classList.remove('d-none');
                if (errorMessage) errorMessage.classList.add('d-none');
                if (productInfo) productInfo.classList.add('d-none');

                // API isteği
                fetch(`/api/products/search/${encodeURIComponent(identifier)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP hata! Durum: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (loadingSpinner) loadingSpinner.classList.add('d-none');

                        if (data.success && data.product) {
                            displayProductInfo(data.product);
                            if (productInfo) productInfo.classList.remove('d-none');
                        } else {
                            if (errorMessage) {
                                errorMessage.textContent = data.message || 'Ürün bulunamadı.';
                                errorMessage.classList.remove('d-none');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('API Hatası:', error);
                        if (loadingSpinner) loadingSpinner.classList.add('d-none');
                        if (errorMessage) {
                            errorMessage.textContent = 'API isteği sırasında bir hata oluştu: ' + error.message;
                            errorMessage.classList.remove('d-none');
                        }
                    });
            }

            /**
             * Ürün Bilgilerini Görüntüleme
             * API'den gelen ürün bilgilerini gösterir ve varyantları tabloya ekler
             */
            function displayProductInfo(product) {
                // Ürün bilgilerini doldur
                const productNameEl = document.getElementById('productName');
                const productIdEl = document.getElementById('productId');
                const productCategoryEl = document.getElementById('productCategory');

                if (productNameEl) productNameEl.textContent = product.name || 'İsimsiz Ürün';
                if (productIdEl) productIdEl.textContent = product.id || '';
                if (productCategoryEl) productCategoryEl.textContent = product.productCategory || '';

                // Varyantları tabloya ekle
                if (product.variants && Array.isArray(product.variants)) {
                    displayVariants(product.variants);
                } else {
                    displayVariants([]);
                }

                // Kategori değişimini dinle
                document.getElementById('categorySelect').addEventListener('change', updateCreateButton);

                // Seçim sayacını güncelle
                updateSelectionCounter();
            }

            /**
             * Varyantları Tabloya Ekleme
             * Ürüne ait varyantları tabloda listeler
             */
            function displayVariants(variants) {
                const variantsTableBody = document.getElementById('variantsTableBody');

                if (variantsTableBody) {
                    variantsTableBody.innerHTML = '';

                    if (variants.length > 0) {
                        variants.forEach(variant => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input variant-checkbox" type="checkbox"
                                               value="${variant.id || ''}"
                                               data-iwasku="${variant.iwasku || ''}"
                                               data-color="${variant.variationColor || ''}"
                                               data-size="${variant.variationSize || ''}">
                                    </div>
                                </td>
                                <td>${variant.id || ''}</td>
                                <td>${variant.iwasku || '-'}</td>
                                <td>${variant.variationColor || '-'}</td>
                                <td>${variant.variationSize || '-'}</td>
                                <td>
                                    <input type="number" class="form-control form-control-sm variant-stock"
                                           min="1" value="10" style="width: 65px;">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm variant-price"
                                           min="0.01" step="0.01" value="100" style="width: 85px;">
                                </td>
                            `;
                            variantsTableBody.appendChild(row);
                        });

                        // Varyant seçildiğinde satırı vurgula ve buton durumunu güncelle
                        document.querySelectorAll('.variant-checkbox').forEach(function(checkbox) {
                            checkbox.addEventListener('change', function() {
                                const row = this.closest('tr');
                                if (this.checked) {
                                    row.classList.add('selected-row');
                                } else {
                                    row.classList.remove('selected-row');
                                }
                                updateCreateButton();
                                updateSelectionCounter();
                            });
                        });

                        console.log(`${variants.length} varyant listelendi.`);
                    } else {
                        variantsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-3">Bu ürüne ait varyant bulunamadı.</td></tr>';
                    }
                }
            }

            /**
             * Tümünü Seç/Kaldır İşlemleri
             * Tablodaki tüm varyantları seçmek veya seçimi kaldırmak için
             */
            document.getElementById('selectAllVariants').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.variant-checkbox').forEach(function(checkbox) {
                    checkbox.checked = isChecked;
                    const row = checkbox.closest('tr');
                    if (isChecked) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                });
                updateCreateButton();
                updateSelectionCounter();
            });

            // Tümünü Seç butonu
            document.getElementById('selectAllVariantsBtn').addEventListener('click', function() {
                document.querySelectorAll('.variant-checkbox').forEach(function(checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('tr').classList.add('selected-row');
                });
                document.getElementById('selectAllVariants').checked = true;
                updateCreateButton();
                updateSelectionCounter();
            });

            // Seçimi Kaldır butonu
            document.getElementById('deselectAllVariantsBtn').addEventListener('click', function() {
                document.querySelectorAll('.variant-checkbox').forEach(function(checkbox) {
                    checkbox.checked = false;
                    checkbox.closest('tr').classList.remove('selected-row');
                });
                document.getElementById('selectAllVariants').checked = false;
                updateCreateButton();
                updateSelectionCounter();
            });

            /**
             * Toplu Stok ve Fiyat Ayarlama
             * Seçili varyantlara toplu stok veya fiyat değeri atama
             */
            document.getElementById('applyBulkStock').addEventListener('click', function() {
                const bulkStock = document.getElementById('bulkStock').value;
                let appliedCount = 0;

                document.querySelectorAll('.variant-checkbox:checked').forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    const stockInput = row.querySelector('.variant-stock');
                    if (stockInput) {
                        stockInput.value = bulkStock;
                        appliedCount++;
                    }
                });

                if (appliedCount > 0) {
                    showToast(`${appliedCount} varyanta stok değeri uygulandı`);
                } else {
                    showToast('Lütfen önce varyant seçin', 'warning');
                }
            });

            document.getElementById('applyBulkPrice').addEventListener('click', function() {
                const bulkPrice = document.getElementById('bulkPrice').value;
                let appliedCount = 0;

                document.querySelectorAll('.variant-checkbox:checked').forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    const priceInput = row.querySelector('.variant-price');
                    if (priceInput) {
                        priceInput.value = bulkPrice;
                        appliedCount++;
                    }
                });

                if (appliedCount > 0) {
                    showToast(`${appliedCount} varyanta fiyat değeri uygulandı`);
                } else {
                    showToast('Lütfen önce varyant seçin', 'warning');
                }
            });

            /**
             * Seçim Sayacını Güncelleme
             * Kaç varyantın seçildiğini gösterir
             */
            function updateSelectionCounter() {
                const selectedCount = document.querySelectorAll('.variant-checkbox:checked').length;
                const totalCount = document.querySelectorAll('.variant-checkbox').length;
                const selectionInfo = document.getElementById('selectionInfo');

                if (selectionInfo) {
                    selectionInfo.textContent = `${selectedCount} / ${totalCount} varyant seçildi`;
                }
            }

            /**
             * Listing Oluştur Butonunu Güncelleme
             * Gerekli seçimler yapıldığında butonu aktifleştirir
             */
            function updateCreateButton() {
                const selectedVariants = document.querySelectorAll('.variant-checkbox:checked').length;
                const selectedCategory = document.getElementById('categorySelect').value;

                // Butonu aktifleştir/deaktifleştir
                const createButton = document.getElementById('createListingBtn');
                if (createButton) {
                    createButton.disabled = !(selectedVariants > 0 && selectedCategory);
                }
            }

            /**
             * Listing Oluşturma İşlemi
             * Seçili varyantları ve kategoriyi API'ye göndererek listing oluşturur
             */
            document.getElementById('createListingBtn').addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('.variant-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('Lütfen en az bir varyant seçin');
                    return;
                }

                const categorySelect = document.getElementById('categorySelect');
                if (!categorySelect || !categorySelect.value) {
                    alert('Lütfen bir kategori seçin');
                    return;
                }

                // Yükleniyor göstergesi
                const createButton = this;
                const originalButtonText = createButton.innerHTML;
                createButton.disabled = true;
                createButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> İşleniyor...';

                // Ürün bilgilerini al
                const productId = document.getElementById('productId')?.textContent || '';
                const productName = document.getElementById('productName')?.textContent || '';
                const productCategory = document.getElementById('productCategory')?.textContent || '';

                // Varyant verilerini topla
                const variants = [];
                selectedCheckboxes.forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    if (!row) return;

                    const stockInput = row.querySelector('.variant-stock');
                    const priceInput = row.querySelector('.variant-price');

                    variants.push({
                        id: checkbox.value || '',
                        iwasku: checkbox.getAttribute('data-iwasku') || '',
                        color: checkbox.getAttribute('data-color') || '',
                        size: checkbox.getAttribute('data-size') || '',
                        stock: stockInput?.value || 0,
                        price: priceInput?.value || 0
                    });
                });

                // Form verisini hazırla
                const formData = {
                    productId: productId,
                    productName: productName,
                    productCategory: productCategory,
                    categoryId: categorySelect.value,
                    variants: variants
                };

                console.log('Gönderilecek veri:', formData);

                // API isteği gönder
                fetch('/create-ciceksepeti-listing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP hata! Durum: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Butonu eski haline getir
                        createButton.disabled = false;
                        createButton.innerHTML = originalButtonText;

                        if (data.success) {
                            showListingResult(data);
                        } else {
                            alert('Hata: ' + (data.message || 'Bilinmeyen bir hata oluştu'));
                        }
                    })
                    .catch(error => {
                        console.error('Listing oluşturma hatası:', error);
                        alert('Bağlantı hatası oluştu: ' + error.message);

                        // Butonu eski haline getir
                        createButton.disabled = false;
                        createButton.innerHTML = originalButtonText;
                    });
            });

            /**
             * Listing Sonuç Modalını Gösterme
             * Başarılı işlem sonucunu detaylı olarak gösterir
             */
            function showListingResult(data) {
                // Mevcut sonuç modalı varsa kaldır
                let existingModal = document.getElementById('listingResultModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Özet verilerini hazırla
                const summary = data.summary || {
                    productName: data.requestData?.productName || '-',
                    productId: data.requestData?.productId || '-',
                    categoryId: data.requestData?.categoryId || '-',
                    variantCount: data.requestData?.variants?.length || 0,
                    totalStock: 0,
                    priceRange: { min: 0, max: 0 }
                };

                // Varyant detaylarını hazırla
                const variants = data.requestData?.variants || [];
                let variantRows = '';

                if (variants.length > 0) {
                    variantRows = variants.map(variant => `
                        <tr>
                            <td>${variant.id || '-'}</td>
                            <td>${variant.iwasku || '-'}</td>
                            <td>${variant.color || '-'}</td>
                            <td>${variant.size || '-'}</td>
                            <td>${variant.stock || '0'}</td>
                            <td>${variant.price || '0'} TL</td>
                        </tr>
                    `).join('');
                } else {
                    variantRows = '<tr><td colspan="6" class="text-center">Varyant bulunamadı</td></tr>';
                }

                // Modal HTML
                const modalHtml = `
                <div class="modal fade" id="listingResultModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Listing Başarıyla Oluşturuldu</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success mb-4">
                                    <i class="fas fa-check-circle me-2"></i> ${data.message || 'Listing başarıyla oluşturuldu'}
                                </div>

                                <h6 class="fw-bold mb-3">Ürün Özeti</h6>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ürün Adı:</span> <span class="fw-bold">${summary.productName || 'Belirtilmemiş'}</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Ürün ID:</span> <span>${summary.productId || 'Belirtilmemiş'}</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Kategori ID:</span> <span>${summary.categoryId || 'Belirtilmemiş'}</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Varyant Sayısı:</span> <span class="badge bg-primary">${summary.variantCount}</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Toplam Stok:</span> <span class="badge bg-info">${summary.totalStock || 'Belirtilmemiş'}</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Fiyat Aralığı:</span> <span>${summary.priceRange?.min || 0} TL - ${summary.priceRange?.max || 0} TL</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <h6 class="fw-bold mb-3">Varyant Detayları</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>IWASKU</th>
                                                <th>Renk</th>
                                                <th>Ebat</th>
                                                <th>Stok</th>
                                                <th>Fiyat</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${variantRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                <a href="/ciceksepeti" class="btn btn-primary">Listeye Dön</a>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                // Modal'ı DOM'a ekle
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Modal'ı göster
                const resultModal = new bootstrap.Modal(document.getElementById('listingResultModal'));
                resultModal.show();

                // Ana modal'ı kapat
                const mainModal = bootstrap.Modal.getInstance(document.getElementById('newListingModal'));
                if (mainModal) {
                    mainModal.hide();
                }
            }

            /**
             * Toast Bildirim Gösterme
             * Kullanıcıya kısa bildirimler göstermek için
             */
            function showToast(message, type = 'info') {
                // Mevcut toast'ı kaldır
                const existingToast = document.querySelector('.toast-notification');
                if (existingToast) {
                    existingToast.remove();
                }

                // Yeni toast oluştur
                const toast = document.createElement('div');
                toast.className = `toast-notification alert alert-${type}`;
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '9999';
                toast.style.minWidth = '250px';
                toast.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                toast.innerHTML = message;

                document.body.appendChild(toast);

                // 3 saniye sonra kaldır
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        });
    </script>
{% endblock %}