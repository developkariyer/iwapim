<?php

namespace App\Command;

use App\Connector\Marketplace\ShopifyConnector;
use Carbon\Carbon;
use Doctrine\DBAL\Exception;
use Pimcore\Console\AbstractCommand;
use Random\RandomException;
use Symfony\Component\Console\Attribute\AsCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Style\SymfonyStyle;
use Pimcore\Model\DataObject\Product;
use Pimcore\Model\DataObject\Marketplace;
use Pimcore\Model\DataObject\VariantProduct;
use Pimcore\Model\DataObject\GroupProduct;
use App\Connector\Marketplace\Amazon\Connector as AmazonConnector;
use App\Connector\Marketplace\Amazon\Constants as AmazonConstants;
use Symfony\Contracts\HttpClient\Exception\ClientExceptionInterface;
use Symfony\Contracts\HttpClient\Exception\RedirectionExceptionInterface;
use Symfony\Contracts\HttpClient\Exception\ServerExceptionInterface;
use Symfony\Contracts\HttpClient\Exception\TransportExceptionInterface;


#[AsCommand(
    name: 'app:console',
    description: 'Interactive Wisersell Connection Console',
)]
class ConsoleCommand extends AbstractCommand
{

    protected static function getJwtRemainingTime($jwt): int
    {
        $jwt = explode('.', $jwt);
        $jwt = json_decode(base64_decode($jwt[1]), true);
        return $jwt['exp'] - time();
    }

    /**
     * @throws TransportExceptionInterface
     * @throws RandomException
     * @throws ServerExceptionInterface
     * @throws RedirectionExceptionInterface
     * @throws ClientExceptionInterface
     * @throws Exception
     * @throws \Exception
     */
    public function setShopifySku(): void
    {   // $this->setShopifySku();

        $shopifyConnectors = [
            23978 => new ShopifyConnector(Marketplace::getById(23978)),/*
            84124 => new ShopifyConnector(Marketplace::getById(84124)),
            108415 => new ShopifyConnector(Marketplace::getById(108415)),
            108416 => new ShopifyConnector(Marketplace::getById(108416)),
            108417 => new ShopifyConnector(Marketplace::getById(108417)),
            108418 => new ShopifyConnector(Marketplace::getById(108418)),
            108419 => new ShopifyConnector(Marketplace::getById(108419)),*/
        ];

        $variantObject = new VariantProduct\Listing();
        $pageSize = 5;
        $offset = 0;
        $variantObject->setLimit($pageSize);
        $variantObject->setUnpublished(false);
        $index = $offset;
        while (true) {
            $variantObject->setOffset($offset);
            $results = $variantObject->load();
            if (empty($results)) {
                break;
            }
            $offset += $pageSize;
            foreach ($results as $listing) {
                $index++;
                echo "\rProcessing $index {$listing->getId()} ";
                if ($listing->getMarketplace()->getMarketplaceType() !== 'Shopify') {
                    continue;
                }
                $marketplaceId = $listing->getMarketplace()->getId();
                $mainProduct = $listing->getMainProduct();
                if (empty($mainProduct)) {
                    echo "No Main Product\n";
                    continue;
                }
                if (is_array($mainProduct)) {
                    $mainProduct = reset($mainProduct);
                }
                if (!$mainProduct instanceof Product) {
                    echo "Main Product is not an instance of Product\n";
                    continue;
                }
                $iwasku = $mainProduct->getIwasku();
                if (empty($iwasku)) {
                    echo "No Iwasku\n";
                    continue;
                }
                $connector = $shopifyConnectors[$marketplaceId] ?? null;
                if (empty($connector)) {
                    //echo "No Connector\n";
                    continue;
                }
                $connector->setSku($listing, $iwasku);
            }
        }
        echo "\nFinished\n";

    }

    /**
     * @throws \Exception
     * @throws TransportExceptionInterface
     */
    public function setShopifyBarcode(): void
    {
        $eans = [
            '174511'=>'8684089415065',
            '174510'=>'8684089415058',
            '174509'=>'8684089415041',
            '174508'=>'8684089415034',
            '181183'=>'8684089415027',
            '181178'=>'8684089415010',
            '177423'=>'8684089415003',
            '177418'=>'8684089414990',
            '178742'=>'8684089414983',
            '178737'=>'8684089414976',
            '175330'=>'8684089414969',
            '175325'=>'8684089414952',
            //'238808'=>'8684089414952',
            '178645'=>'8684089414907',
            '178644'=>'8684089414891',
            '178643'=>'8684089414884',
            '178642'=>'8684089414877',
            '178641'=>'8684089414860',
            '178640'=>'8684089414853',
            '178639'=>'8684089414846',
            '178638'=>'8684089414839',
            //'268099'=>'8684089414839',
            '239469'=>'8684089414822',
            '239468'=>'8684089414815',
            '235050'=>'8684089414808',
            '235049'=>'8684089414792',
            '239467'=>'8684089414785',
            '239466'=>'8684089414778',
            '235048'=>'8684089414761',
            '235047'=>'8684089414754',
            '174442'=>'8684089414716',
            '174437'=>'8684089414709',
            '178721'=>'8684089414693',
            '255840'=>'8684089414532',
            '250080'=>'8684089414525',
            '255868'=>'8684089414518',
            '250086'=>'8684089414501',
            '255848'=>'8684089414495',
            '180852'=>'8684089414457',
            '180851'=>'8684089414440',
            '180850'=>'8684089414433',
            '178750'=>'8684089414426',
            '178749'=>'8684089414419',
            '178748'=>'8684089414402',
            '178245'=>'8684089414396',
            '178244'=>'8684089414389',
            '178243'=>'8684089414372',
            '178231'=>'8684089414365',
            '178230'=>'8684089414358',
            '178229'=>'8684089414341',
            '177357'=>'8684089413764',
            '177356'=>'8684089413757',
            '177355'=>'8684089413740',
            '177933'=>'8684089413603',
            '175357'=>'8684089413597',
            '175358'=>'8684089413580',
            '175355'=>'8684089413573',
            '175356'=>'8684089413566',
            '175353'=>'8684089413559',
            '175354'=>'8684089413542',
            '175351'=>'8684089413535',
            '175352'=>'8684089413528',
            '175349'=>'8684089413511',
            '175350'=>'8684089413504',
            '175347'=>'8684089413498',
            '175348'=>'8684089413481',
            '174222'=>'8684089413474',
            '174218'=>'8684089413467',
            '174220'=>'8684089413450',
            '174221'=>'8684089413443',
            '174217'=>'8684089413436',
            '174219'=>'8684089413429',
            '178563'=>'8684089413412',
            '178562'=>'8684089413405',
            '178561'=>'8684089413399',
            '178560'=>'8684089413382',
            '179107'=>'8684089413337',
            '179105'=>'8684089413320',
            '179106'=>'8684089413313',
            '179104'=>'8684089413306',
            '180285'=>'8684089413290',
            '180284'=>'8684089413283',
            '180283'=>'8684089413276',
            '180282'=>'8684089413269',
            '177882'=>'8684089413252',
            '178663'=>'8684089413245',
            '178662'=>'8684089413238',
            '177198'=>'8684089413221',
            '178545'=>'8684089413214',
            '176303'=>'8684089413207',
            '176299'=>'8684089413191',
            '176295'=>'8684089413184',
            '176302'=>'8684089413177',
            '176298'=>'8684089413160',
            '176294'=>'8684089413153',
            '176305'=>'8684089413146',
            '176301'=>'8684089413139',
            '176297'=>'8684089413122',
            '176304'=>'8684089413115',
            '176300'=>'8684089413108',
            '176296'=>'8684089413092',
            '179229'=>'8684089413047',
            '179230'=>'8684089413030',
            '175258'=>'8684089413023',
            '175259'=>'8684089413016',
            '175261'=>'8684089413009',
            '175260'=>'8684089412996',
            '175257'=>'8684089412989',
            '175256'=>'8684089412972',
            '175255'=>'8684089412965',
            '175253'=>'8684089412958',
            '175254'=>'8684089412941',
            '175249'=>'8684089412934',
            '175250'=>'8684089412927',
            '175252'=>'8684089412910',
            '175251'=>'8684089412903',
            '175248'=>'8684089412897',
            '175247'=>'8684089412880',
            '175246'=>'8684089412873',
            '175244'=>'8684089412866',
            '175245'=>'8684089412859',
            '179111'=>'8684089412774',
            '179113'=>'8684089412767',
            '176727'=>'8684089412750',
            '238841'=>'8684089412750',
            '179076'=>'8684089412729',
            '176816'=>'8684089412712',
            '174960'=>'8684089412705',
            '174913'=>'8684089412699',
            '174921'=>'8684089412682',
            '177800'=>'8684089412668',
            '178804'=>'8684089412651',
            '175646'=>'8684089412644',
            '176890'=>'8684089412620',
            '176732'=>'8684089412606',
            '238844'=>'8684089412606',
            '176820'=>'8684089412590',
            '177801'=>'8684089412583',
            '174952'=>'8684089412576',
            '174962'=>'8684089412569',
            '174965'=>'8684089412552',
            '178014'=>'8684089412545',
            '176409'=>'8684089412538',
            '174971'=>'8684089412521',
            '175644'=>'8684089412514',
            '178012'=>'8684089412507',
            '178016'=>'8684089412491',
            '174980'=>'8684089412477',
            '179429'=>'8684089412460',
            '174290'=>'8684089412453',
            '179520'=>'8684089412446',
            '178018'=>'8684089412439',
            '176821'=>'8684089412422',
            '177798'=>'8684089412415',
            '176674'=>'8684089411852',
            '175696'=>'8684089411845',
            '180512'=>'8684089411838',
            '180614'=>'8684089411838',
            '174293'=>'8684089411821',
            '179075'=>'8684089411814',
            '176889'=>'8684089411807',
            '180021'=>'8684089411791',
            '178899'=>'8684089411722',
            '178896'=>'8684089411715',
            '178893'=>'8684089411708',
            '179346'=>'8684089411692',
            '179343'=>'8684089411685',
            '176726'=>'8684089411678',
            '238840'=>'8684089411678',
            '176729'=>'8684089411661',
            '238842'=>'8684089411661',
            '176723'=>'8684089411654',
            '179430'=>'8684089411647',
            '179071'=>'8684089411630',
            '178477'=>'8684089411623',
            '174905'=>'8684089411616',
            '176285'=>'8684089411609',
            '176819'=>'8684089411593',
            '179115'=>'8684089411586',
            '179112'=>'8684089411579',
            '174978'=>'8684089411562',
            '177799'=>'8684089411555',
            '178468'=>'8684089411531',
            '174844'=>'8684089411524',
            '174843'=>'8684089411517',
            '174849'=>'8684089411500',
            '174738'=>'8684089411494',
            '177999'=>'8684089411487',
            '178904'=>'8684089411470',
            '178903'=>'8684089411463',
            '178909'=>'8684089411456',
            '178805'=>'8684089411432',
            '238838'=>'8684089411432',
            '177160'=>'8684089411425',
            '179819'=>'8684089411418',
            '179822'=>'8684089411401',
            '179816'=>'8684089411395',
            '176415'=>'8684089411388',
            '176416'=>'8684089411371',
            '176412'=>'8684089411364',
            '176715'=>'8684089411357',
            '179077'=>'8684089411340',
            '180193'=>'8684089411333',
            '245842'=>'8684089411326',
            '175226'=>'8684089411319',
            '175373'=>'8684089411319',
            '175440'=>'8684089411319',
            '173900'=>'8684089411302',
            '245839'=>'8684089411296',
            '175794'=>'8684089411289',
            '179423'=>'8684089411272',
            '175221'=>'8684089411265',
            '175367'=>'8684089411265',
            '175435'=>'8684089411265',
            '178474'=>'8684089411258',
            '174908'=>'8684089411241',
            '179081'=>'8684089411234',
            '179431'=>'8684089411227',
            '175222'=>'8684089411210',
            '175375'=>'8684089411210',
            '175436'=>'8684089411210',
            '176280'=>'8684089411203',
            '179428'=>'8684089411197',
            '174759'=>'8684089411180',
            '179131'=>'8684089411180',
            '180413'=>'8684089411159',
            '177807'=>'8684089411135',
            '176955'=>'8684089411111',
            '176845'=>'8684089411104',
            '180505'=>'8684089411104',
            '180506'=>'8684089411104',
            '180613'=>'8684089411104',
            '174287'=>'8684089411098',
            '176888'=>'8684089411081',
            '176887'=>'8684089411074',
            '176886'=>'8684089411067',
            '176885'=>'8684089411050',
            '180022'=>'8684089411043',
            '174758'=>'8684089411036',
            '179134'=>'8684089411036',
            '176279'=>'8684089411029',
            '180010'=>'8684089411012',
            '180009'=>'8684089411005',
            '180011'=>'8684089410992',
            '180012'=>'8684089410985',
            '174876'=>'8684089410978',
            '245843'=>'8684089410978',
            '179185'=>'8684089410961',
            '179184'=>'8684089410954',
            '179183'=>'8684089410947',
            '179182'=>'8684089410930',
            '179181'=>'8684089410923',
            '179180'=>'8684089410916',
            '179173'=>'8684089410909',
            '179172'=>'8684089410893',
            '179171'=>'8684089410886',
            '179170'=>'8684089410879',
            '179169'=>'8684089410862',
            '179168'=>'8684089410855',
            '179072'=>'8684089410848',
            '174875'=>'8684089410831',
            '245840'=>'8684089410831',
            '178472'=>'8684089410824',
            '179073'=>'8684089410817',
            '178898'=>'8684089410800',
            '178895'=>'8684089410794',
            '178892'=>'8684089410787',
            '178800'=>'8684089410770',
            '178803'=>'8684089410763',
            '173981'=>'8684089410756',
            '173980'=>'8684089410749',
            '238746'=>'8684089410749',
            '176733'=>'8684089410732',
            '238845'=>'8684089410732',
            '176730'=>'8684089410725',
            '238843'=>'8684089410725',
            '176724'=>'8684089410718',
            '179348'=>'8684089410701',
            '179345'=>'8684089410695',
            '179347'=>'8684089410688',
            '179344'=>'8684089410671',
            '239149'=>'8684089410671',
            '178831'=>'8684089410664',
            '178830'=>'8684089410657',
            '178876'=>'8684089410640',
            '178875'=>'8684089410633',
            '178885'=>'8684089410626',
            '178814'=>'8684089410619',
            '178813'=>'8684089410602',
            '179078'=>'8684089410596',
            '178573'=>'8684089410589',
            '179424'=>'8684089410572',
            '176283'=>'8684089410565',
            '179425'=>'8684089410558',
            '178362'=>'8684089410541',
            '178360'=>'8684089410534',
            '178366'=>'8684089410527',
            '178364'=>'8684089410510',
            '176817'=>'8684089410503',
            '176818'=>'8684089410497',
            '176815'=>'8684089410480',
            '176822'=>'8684089410473',
            '179142'=>'8684089410466',
            '268109'=>'8684089410466',
            '179109'=>'8684089410459',
            '179114'=>'8684089410442',
            '179110'=>'8684089410435',
            '179108'=>'8684089410428',
            '174953'=>'8684089410411',
            '174959'=>'8684089410404',
            '174966'=>'8684089410398',
            '174969'=>'8684089410381',
            '174970'=>'8684089410374',
            '174968'=>'8684089410367',
            '174975'=>'8684089410350',
            '174974'=>'8684089410343',
            '174979'=>'8684089410336',
            '174977'=>'8684089410329',
            '174984'=>'8684089410312',
            '174983'=>'8684089410305',
            '175640'=>'8684089410299',
            '176882'=>'8684089410282',
            '176883'=>'8684089410275',
            '176876'=>'8684089410268',
            '176877'=>'8684089410251',
            '176880'=>'8684089410244',
            '176881'=>'8684089410237',
            '176878'=>'8684089410220',
            '176879'=>'8684089410213',
            '175645'=>'8684089410206',
            '175643'=>'8684089410190',
            '175581'=>'8684089410176',
            '175578'=>'8684089410169',
            '175575'=>'8684089410152',
            '175572'=>'8684089410145',
            '175580'=>'8684089410138',
            '175577'=>'8684089410121',
            '175574'=>'8684089410114',
            '175571'=>'8684089410107',
            '175579'=>'8684089410091',
            '175576'=>'8684089410084',
            '175573'=>'8684089410077',
            '175570'=>'8684089410060',
            '178475'=>'8684089410053',
            '174848'=>'8684089410046',
            '174847'=>'8684089410039',
            '174845'=>'8684089410022',
            '174846'=>'8684089410015',
            '174842'=>'8684089410008',
            '176286'=>'8684089409996',
            '179421'=>'8684089409989',
            '174751'=>'8684089409972',
            '179128'=>'8684089409972',
            '179070'=>'8684089409965',
            '177740'=>'8684089409958',
            '177738'=>'8684089409941',
            '178476'=>'8684089409934',
            '176284'=>'8684089409927',
            '178907'=>'8684089409910',
            '178910'=>'8684089409903',
            '178908'=>'8684089409897',
            '178906'=>'8684089409880',
            '179120'=>'8684089409873',
            '174925'=>'8684089409866',
            '178802'=>'8684089409859',
            '238839'=>'8684089409859',
            '245838'=>'8684089409842',
            '174830'=>'8684089409835',
            '174828'=>'8684089409828',
            '174826'=>'8684089409811',
            '174824'=>'8684089409804',
            '174822'=>'8684089409798',
            '174820'=>'8684089409781',
            '179233'=>'8684089409774',
            '179235'=>'8684089409767',
            '179232'=>'8684089409750',
            '179234'=>'8684089409743',
            '179079'=>'8684089409736',
            '179420'=>'8684089409729',
            '270226'=>'8684089409729',
            '176894'=>'8684089409712',
            '176893'=>'8684089409705',
            '176892'=>'8684089409699',
            '176903'=>'8684089409682',
            '176902'=>'8684089409675',
            '176901'=>'8684089409668',
            '179823'=>'8684089409651',
            '179074'=>'8684089409644',
            '176411'=>'8684089409620',
            '176413'=>'8684089409613',
            '176414'=>'8684089409606',
            '176410'=>'8684089409590',
            '174917'=>'8684089409583',
            '176719'=>'8684089409576',
            '174920'=>'8684089409569',
            '245841'=>'8684089409552',
            '176281'=>'8684089409545',
            '179422'=>'8684089409538',
            '178473'=>'8684089409521',
            '178902'=>'8684089409514',
            '179426'=>'8684089409507',
            '178058'=>'8684089409491',
            '176282'=>'8684089409484',
            '174752'=>'8684089409477',
            '179125'=>'8684089409477',
            '178905'=>'8684089409453',
            '174002'=>'8684089409446',
            '174003'=>'8684089409439',
            '174001'=>'8684089409422',
            '173999'=>'8684089409415',
            '174000'=>'8684089409408',
            '173998'=>'8684089409392',
            '174906'=>'8684089409347',
            '175668'=>'8684089409330',
            '175662'=>'8684089409323',
            '175656'=>'8684089409316',
            '175667'=>'8684089409309',
            '175661'=>'8684089409293',
            '175655'=>'8684089409286',
            '176064'=>'8684089409217',
            '176062'=>'8684089409200',
            '177321'=>'8684089409156',
            '175811'=>'8684089409033',
            '175883'=>'8684089409033',
            '175808'=>'8684089409026',
            '175877'=>'8684089409026',
            '179596'=>'8684089409026',
            '175805'=>'8684089409002',
            '175871'=>'8684089409002',
            '178811'=>'8684089408975',
            '174441'=>'8684089408784',
            '174436'=>'8684089408777',
            '178793'=>'8684089408708',
            '174284'=>'8684089408562',
            '174275'=>'8684089408555',
            '174278'=>'8684089408401',
            '174281'=>'8684089408395',
            '174269'=>'8684089408388',
            '174918'=>'8684089408364',
            '178672'=>'8684089408357',
            '178673'=>'8684089408340',
            '178674'=>'8684089408333',
            '178676'=>'8684089408326',
            '178677'=>'8684089408319',
            '178678'=>'8684089408302',
            '176063'=>'8684089408005',
            '176652'=>'8684089407961',
            '176856'=>'8684089407879',
            '178336'=>'8684089407879',
            '178348'=>'8684089407862',
            '176854'=>'8684089407855',
            '178292'=>'8684089407855',
            '178326'=>'8684089407848',
            '178304'=>'8684089407831',
            '174858'=>'8684089407817',
            '174855'=>'8684089407800',
            '268807'=>'8684089407800',
            '174857'=>'8684089407794',
            '174856'=>'8684089407787',
            '268809'=>'8684089407787',
            '174862'=>'8684089407770',
            '174859'=>'8684089407763',
            '268811'=>'8684089407763',
            '174861'=>'8684089407756',
            '174860'=>'8684089407749',
            '268813'=>'8684089407749',
            '174866'=>'8684089407732',
            '174863'=>'8684089407725',
            '268815'=>'8684089407725',
            '174865'=>'8684089407718',
            '174864'=>'8684089407701',
            '268817'=>'8684089407701',
            '179201'=>'8684089407671',
            '179197'=>'8684089407664',
            '179200'=>'8684089407657',
            '179196'=>'8684089407640',
            '179199'=>'8684089407633',
            '179195'=>'8684089407626',
            '178363'=>'8684089407572',
            '178365'=>'8684089407565',
            '178361'=>'8684089407558',
            '178359'=>'8684089407541',
            '174853'=>'8684089407534',
            '174852'=>'8684089407527',
            '174851'=>'8684089407510',
            '174850'=>'8684089407503',
            '174768'=>'8684089407497',
            '174767'=>'8684089407480',
            '174765'=>'8684089407473',
            '179140'=>'8684089407473',
            '174766'=>'8684089407466',
            '179137'=>'8684089407466',
            '174769'=>'8684089407459',
            '174770'=>'8684089407442',
            '249365'=>'8684089407022',
            '249364'=>'8684089407015',
            '249363'=>'8684089407008',
            '249362'=>'8684089406995',
            '249361'=>'8684089406988',
            '249354'=>'8684089406971',
            '249353'=>'8684089406964',
            '249352'=>'8684089406957',
            '249351'=>'8684089406940',
            '249350'=>'8684089406933',
            '249343'=>'8684089406926',
            '249342'=>'8684089406919',
            '249341'=>'8684089406902',
            '249340'=>'8684089406896',
            '249339'=>'8684089406889',
            '179355'=>'8684089406759',
            '179358'=>'8684089406742',
            '179361'=>'8684089406735',
            '179352'=>'8684089406728',
            '179354'=>'8684089406711',
            '179357'=>'8684089406704',
            '179360'=>'8684089406698',
            '179351'=>'8684089406681',
            '179353'=>'8684089406674',
            '179356'=>'8684089406667',
            '179359'=>'8684089406650',
            '179350'=>'8684089406643',
            '178589'=>'8684089406599',
            '178588'=>'8684089406582',
            '176435'=>'8684089406575',
            '176434'=>'8684089406568',
            '176433'=>'8684089406551',
            '179193'=>'8684089406513',
            '176314'=>'8684089406506',
            '176312'=>'8684089406490',
            '176308'=>'8684089406483',
            '176310'=>'8684089406476',
            '176313'=>'8684089406469',
            '176311'=>'8684089406452',
            '176307'=>'8684089406445',
            '176309'=>'8684089406438',
            '176663'=>'8684089406278',
            '176661'=>'8684089406261',
            '176657'=>'8684089406254',
            '176659'=>'8684089406247',
            '176662'=>'8684089406230',
            '176660'=>'8684089406223',
            '176656'=>'8684089406216',
            '176658'=>'8684089406209',
            '176429'=>'8684089406117',
            '176427'=>'8684089406100',
            '176431'=>'8684089406094',
            '176425'=>'8684089406087',
            '176428'=>'8684089406070',
            '176426'=>'8684089406063',
            '176430'=>'8684089406056',
            '176424'=>'8684089406049',
            '176824'=>'8684089406032',
            '178970'=>'8684089406025',
            '178858'=>'8684089406018',
            '178856'=>'8684089406001',
            '174829'=>'8684089405998',
            '174827'=>'8684089405981',
            '174831'=>'8684089405974',
            '174823'=>'8684089405967',
            '174821'=>'8684089405950',
            '174825'=>'8684089405943',
            '174819'=>'8684089405936',
            '180818'=>'8684089405455',
            '180816'=>'8684089405448',
            '180815'=>'8684089405431',
            '180817'=>'8684089405424',
            '180814'=>'8684089405417',
            '180812'=>'8684089405400',
            '180811'=>'8684089405394',
            '180813'=>'8684089405387',
            '180848'=>'8684089405370',
            '180846'=>'8684089405363',
            '180847'=>'8684089405356',
            '180845'=>'8684089405349',
            '180274'=>'8684089405219',
            '180278'=>'8684089405202',
            '180280'=>'8684089405196',
            '180276'=>'8684089405189',
            '180273'=>'8684089405172',
            '180277'=>'8684089405165',
            '180279'=>'8684089405158',
            '180275'=>'8684089405141',
            '177805'=>'8684089404267',
            '177804'=>'8684089404250',
            '177803'=>'8684089404243',
            '177164'=>'8684089404236',
            '177163'=>'8684089404229',
            '175337'=>'8684089404182',
            '175336'=>'8684089404175',
            '178807'=>'8684089404168',
            '178833'=>'8684089404151',
            '178785'=>'8684089404137',
            '178787'=>'8684089404137',
            '176288'=>'8684089404083',
            '176287'=>'8684089404076',
            '176544'=>'8684089404069',
            '176543'=>'8684089404052',
            '176059'=>'8684089404045',
            '176061'=>'8684089404038',
            '174453'=>'8684089404021',
            '174449'=>'8684089404014',
            '174451'=>'8684089404007',
            '174447'=>'8684089403994',
            '174452'=>'8684089403987',
            '174448'=>'8684089403970',
            '174450'=>'8684089403963',
            '174446'=>'8684089403956',
            '179205'=>'8684089403925',
            '179209'=>'8684089403918',
            '179204'=>'8684089403901',
            '179208'=>'8684089403895',
            '179203'=>'8684089403888',
            '179207'=>'8684089403871',
            '174114'=>'8684089403864',
            '174128'=>'8684089403857',
            '174115'=>'8684089403833',
            '174349'=>'8684089403802',
            '174352'=>'8684089403796',
            '174355'=>'8684089403789',
            '174348'=>'8684089403772',
            '174351'=>'8684089403765',
            '174354'=>'8684089403758',
            '174347'=>'8684089403741',
            '174350'=>'8684089403734',
            '174353'=>'8684089403727',
            '173956'=>'8684089403710',
            '173957'=>'8684089403703',
            '176057'=>'8684089403697',
            '176053'=>'8684089403680',
            '176049'=>'8684089403673',
            '176045'=>'8684089403666',
            '176056'=>'8684089403659',
            '176052'=>'8684089403642',
            '176048'=>'8684089403635',
            '176044'=>'8684089403628',
            '176055'=>'8684089403611',
            '176051'=>'8684089403604',
            '176047'=>'8684089403598',
            '176043'=>'8684089403581',
            '176054'=>'8684089403574',
            '176050'=>'8684089403567',
            '176046'=>'8684089403550',
            '176042'=>'8684089403543',
            '179371'=>'8684089403529',
            '174316'=>'8684089403482',
            '174319'=>'8684089403475',
            '174310'=>'8684089403451',
            '174313'=>'8684089403444',
            '174810'=>'8684089403420',
            '174806'=>'8684089403413',
            '174802'=>'8684089403406',
            '174798'=>'8684089403390',
            '174809'=>'8684089403383',
            '174805'=>'8684089403376',
            '174801'=>'8684089403369',
            '174797'=>'8684089403352',
            '174808'=>'8684089403338',
            '174804'=>'8684089403321',
            '174800'=>'8684089403314',
            '174796'=>'8684089403307',
            '174807'=>'8684089403291',
            '174803'=>'8684089403284',
            '174799'=>'8684089403277',
            '174795'=>'8684089403260',
            '180239'=>'8684089403253',
            '180237'=>'8684089403246',
            '180233'=>'8684089403239',
            '180235'=>'8684089403222',
            '180238'=>'8684089403215',
            '180236'=>'8684089403208',
            '180232'=>'8684089403192',
            '180234'=>'8684089403185',
            '175318'=>'8684089403178',
            '175317'=>'8684089403161',
            '174395'=>'8684089403154',
            '174400'=>'8684089403147',
            '174396'=>'8684089403130',
            '174401'=>'8684089403123',
            '174393'=>'8684089403116',
            '174398'=>'8684089403109',
            '174394'=>'8684089403093',
            '174399'=>'8684089403086',
            '174937'=>'8684089403079',
            '174938'=>'8684089403062',
            '174936'=>'8684089403055',
            '174935'=>'8684089403048',
            '174932'=>'8684089403031',
            '174933'=>'8684089403024',
            '174931'=>'8684089403017',
            '174930'=>'8684089403000',
            '178032'=>'8684089402973',
            '178031'=>'8684089402942',
            '178030'=>'8684089402911',
            '173918'=>'8684089402553',
            '173917'=>'8684089402546',
            '173920'=>'8684089402539',
            '173919'=>'8684089402522',
        ];
        $connector = new ShopifyConnector(Marketplace::getById(23978));
        $carbon7daysAgo = Carbon::now()->subDays(7);
        foreach ($eans as $id => $ean) {
            echo "$id $ean\n";
            $variantProduct = VariantProduct::getById($id);
            if (!$variantProduct || $variantProduct->getLastUpdate() < $carbon7daysAgo) {
                echo "VariantProduct $id not found or too old\n";
                continue;
            }
            $connector->setBarcode($variantProduct, $ean);
        }
    }

    public function connectAmazonUs()
    {   // $this->connectAmazonUs();
        $grp = GroupProduct::getById(267975);
        $grpArray = [];
        $prdListObj = new Product\Listing();
        $prdListObj->setUnpublished(false);
        $prdList = $prdListObj->load();
        foreach ($prdList as $prd) {
            $found = false;
            echo "{$prd->getId()} ";
            $listings = $prd->getListingItems();
            foreach ($listings as $listing) {
                echo "{$listing->getId()} ";
                $amazonMarketplaces = $listing->getAmazonMarketplace() ?? [];
                foreach ($amazonMarketplaces as $amazonMarketplace) {
                    echo "{$amazonMarketplace->getMarketplaceId()} ";
                    if ($amazonMarketplace->getStatus() === 'Active' && $amazonMarketplace->getMarketplaceId() === 'US') {
                        $grpArray[] = $prd;
                        echo "added";
                        $found = true;
                        break;
                    }
                }
                if ($found) {
                    break;
                }
            }
            echo "\n";
        }
        $grp->setProducts($grpArray);
        $grp->save();
    }

    public function deleteFr()
    {   // $this->deleteFr();
        $db = \Pimcore\Db::get();
        $amazonConnector = new AmazonConnector(Marketplace::getById(200568)); // UK Amazon
        $amazonEuMarkets = ['IT', 'FR']; //['DE', 'FR', 'IT', 'ES', 'NL', 'BE', 'SE', 'PL'];
        $euMarketsPlaceholder = implode("','", $amazonEuMarkets);
        $query = "
            SELECT marketplaceId, sku
            FROM object_collection_AmazonMarketplace_varyantproduct
            WHERE fieldname = 'amazonMarketplace' 
                AND marketplaceId IN ('$euMarketsPlaceholder')
            ORDER BY marketplaceId, sku
        ";
        $skulist = $db->fetchAllAssociative($query);
        $total = count($skulist);
        $index = 0;
        foreach ($skulist as $sku) {
            $index++;
            echo "\rProcessing $index/$total ";
            $country = $sku['marketplaceId'];
            if (!in_array($country, $amazonEuMarkets)) {
                continue;
            }
            $sku = $sku['sku'];
            echo " $country $sku ";
            try {
                $amazonConnector->utilsHelper->patchGPSR($sku, $country);
            } catch (\Exception $e) {
                echo "Error: ".$e->getMessage()."\n";
            }
        }
        echo "\nFinished\n";
    }

    public function addMatteToVariantColors()
    {   // $this->addMatteToVariantColors();
        $pageSize = 5;
        $offset = 0;
        $listingObject = new Product\Listing();
        $listingObject->setUnpublished(true);
        $listingObject->setLimit($pageSize);
        $index = $offset;
        while (true) {
            $listingObject->setOffset($offset);
            $products = $listingObject->load();
            if (empty($products)) {
                break;
            }
            $offset += $pageSize;
            foreach ($products as $product) {
                $index++;
                echo "\rProcessing $index {$product->getId()} ";
                if ($product->level() < 1 || $product->getInheritedField('productCategory') !== 'IWA Metal') {
                    continue;
                }
                $variationColor = $product->getVariationColor();
                if (in_array($variationColor, ['Gold', 'Copper', 'Silver', 'IGOB', 'IGOS', 'ISOB', 'ISOG'])) {
                    echo "{$product->getInheritedField('productCategory')} {$variationColor} ";
                    $product->setVariationColor("Matte {$variationColor}");
                    $product->save();
                    echo "saved\n";
                    file_put_contents(PIMCORE_PROJECT_ROOT . "/tmp/product_add_matte.log", json_encode([
                        'timestamp' => date('Y-m-d H:i:s'),
                        'product' => $product->getId(),
                        'productCategory' => $product->getInheritedField('productCategory'),
                        'oldVariationColor' => $variationColor,
                        'newVariationColor' => "Matte {$variationColor}"
                    ]) . "\n", FILE_APPEND);
                }
            }
        }
    }

    public function getAmazonInfo()
    {   // $this->getAmazonInfo();
        
        $amazonConnector = [
            [
                'connector' => new AmazonConnector(Marketplace::getById(200568)), // UK Amazon
                'countries' => ['UK', 'DE', 'FR', 'IT', 'ES', 'NL', 'TR', 'SE', 'PL'],
            ],
            [
                'connector' => new AmazonConnector(Marketplace::getById(149795)), // US Amazon
                'countries' => ['US', 'MX'],
            ],
            [
                'connector' => new AmazonConnector(Marketplace::getById(234692)), // CA Amazon
                'countries' => ['CA'],
            ]
        ];
        $variantObject = new VariantProduct\Listing();
        $pageSize = 5;
        $offset = 0;
        $variantObject->setLimit($pageSize);
        $variantObject->setUnpublished(false);
        $index = $offset;
        while (true) {
            $variantObject->setOffset($offset);
            $results = $variantObject->load();
            if (empty($results)) {
                break;
            }
            $offset += $pageSize;
            foreach ($results as $listing) {
                $index++;
                echo "\rProcessing $index {$listing->getId()}";
                $amazonMarketplaces = $listing->getAmazonMarketplace() ?? [];
                if (empty($amazonMarketplaces)) {
                    continue;
                }
                echo "\n";
                foreach ($amazonMarketplaces as $amazonMarketplace) {
                    $country = $amazonMarketplace->getMarketplaceId();
                    foreach ($amazonConnector as $connector) {
                        if (!in_array($country, $connector['countries'])) {
                            continue;
                        }
                        $sku = $amazonMarketplace->getSku();
                        if (empty($sku)) {
                            continue;
                        }
                        echo " $country:$sku";
                        $connector['connector']->utilsHelper->getInfo($sku, $country);
                    }
                }
                echo "\n";
            }
        }
        echo "\nFinished\n";
    }

    protected function execute(InputInterface $input, OutputInterface $output): int
    {
        //$amazon = new AmazonConnector(Marketplace::getById(149795)); // US: 149795  UK: 200568
        //$amazon->patchCustom(sku: "CA_41_Burgundy_XL", country: "US", attribute: "item_type_keyword", operation: "delete", value: "");

        $io = new SymfonyStyle($input, $output);
        $io->title('IWAPIM Interactive Shell');
        $context = [];

        while (true) {
            $command = $io->ask('');
            if (trim($command) === 'exit') {
                $io->success('Goodbye!');
                return 0;
            }
            try {
                $result = eval($command . ';');
                if ($result !== null) {
                    $io->writeln(var_export($result, true));
                }
                echo "\n";
                $context = get_defined_vars();
            } catch (\Throwable $e) {
                $outputCaptured = ob_get_clean();
                if (!empty($outputCaptured)) {
                    $io->writeln($outputCaptured);
                }
                $io->error($e->getMessage());
            }
        }
    }
}
